name: Simple WXpusher Test

on:
  workflow_dispatch:

jobs:
  test-wxpusher-simple:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Test WXpusher Configuration
      run: |
        echo "## ðŸ” WXpusheré…ç½®è¯Šæ–­" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥AppToken
        if [ -z "${{ secrets.WXPUSHER_APP_TOKEN }}" ]; then
          echo "âŒ **WXPUSHER_APP_TOKEN æœªé…ç½®**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½® > Secrets and variables > Actions ä¸­æ·»åŠ  WXPUSHER_APP_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ å¦‚ä½•æ·»åŠ  WXPUSHER_APP_TOKEN:" >> $GITHUB_STEP_SUMMARY
          echo "1. è®¿é—® [WXpusherç®¡ç†åŽå°](https://wxpusher.zjiecode.com/admin)" >> $GITHUB_STEP_SUMMARY
          echo "2. èŽ·å–æ‚¨åº”ç”¨çš„ AppToken" >> $GITHUB_STEP_SUMMARY
          echo "3. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ æ–°çš„ Secret" >> $GITHUB_STEP_SUMMARY
          echo "4. åç§°ä¸º: \`WXPUSHER_APP_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "5. å€¼ä¸ºæ‚¨çš„ WXpusher AppToken" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… **WXPUSHER_APP_TOKEN å·²é…ç½®**" >> $GITHUB_STEP_SUMMARY
          echo "Tokené•¿åº¦: $(echo -n "${{ secrets.WXPUSHER_APP_TOKEN }}" | wc -c) å­—ç¬¦" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: Create simple WXpusher test
      run: |
        cat > test-wxpusher-simple.js << 'EOF'
        const axios = require('axios');
        
        const appToken = process.env.WXPUSHER_APP_TOKEN;
        
        console.log('ðŸ§ª å¼€å§‹ç®€å•WXpusheræµ‹è¯•...');
        console.log('AppToken:', appToken ? `${appToken.length}å­—ç¬¦` : 'æœªé…ç½®');
        
        if (!appToken) {
          console.error('âŒ WXPUSHER_APP_TOKEN çŽ¯å¢ƒå˜é‡æœªè®¾ç½®');
          process.exit(1);
        }
        
        async function testWXpusher() {
          try {
            // æµ‹è¯•èŽ·å–åº”ç”¨ä¿¡æ¯
            console.log('ðŸ“¤ æµ‹è¯•èŽ·å–åº”ç”¨ä¿¡æ¯...');
            const appInfoResponse = await axios.get(`https://wxpusher.zjiecode.com/api/fun/app/${appToken}`);
            console.log('âœ… åº”ç”¨ä¿¡æ¯:', appInfoResponse.data);
            
            // æµ‹è¯•èŽ·å–ç”¨æˆ·åˆ—è¡¨
            console.log('ðŸ“¤ æµ‹è¯•èŽ·å–ç”¨æˆ·åˆ—è¡¨...');
            const usersResponse = await axios.get('https://wxpusher.zjiecode.com/api/fun/wxuser', {
              params: {
                appToken: appToken,
                page: 1,
                pageSize: 10
              }
            });
            console.log('âœ… ç”¨æˆ·åˆ—è¡¨:', usersResponse.data);
            
            // å¦‚æžœæœ‰ç”¨æˆ·ï¼Œå‘é€æµ‹è¯•æ¶ˆæ¯
            if (usersResponse.data.data && usersResponse.data.data.records && usersResponse.data.data.records.length > 0) {
              const userIds = usersResponse.data.data.records.map(user => user.uid);
              console.log('ðŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°ç”¨æˆ·:', userIds);
              
              const messageResponse = await axios.post('https://wxpusher.zjiecode.com/api/send/message', {
                appToken: appToken,
                contentType: 1,
                content: 'ðŸ§ª WXpusheræµ‹è¯•æ¶ˆæ¯ï¼\n\næ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\n\nå¦‚æžœæ‚¨çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜ŽWXpusheré…ç½®æ­£ç¡®ï¼',
                summary: 'WXpusheré…ç½®æµ‹è¯•',
                uids: userIds
              });
              
              console.log('âœ… æ¶ˆæ¯å‘é€ç»“æžœ:', messageResponse.data);
              
              if (messageResponse.data.code === 1000) {
                console.log('ðŸŽ‰ WXpusheré…ç½®æ­£ç¡®ï¼æ¶ˆæ¯å·²å‘é€ï¼');
              } else {
                console.error('âŒ æ¶ˆæ¯å‘é€å¤±è´¥:', messageResponse.data.msg);
              }
            } else {
              console.warn('âš ï¸ æ²¡æœ‰å…³æ³¨ç”¨æˆ·ï¼Œè¯·ç¡®ä¿æ‚¨å·²å…³æ³¨WXpusherå…¬ä¼—å·å¹¶æ·»åŠ äº†æ‚¨çš„åº”ç”¨');
            }
            
          } catch (error) {
            console.error('âŒ æµ‹è¯•å¤±è´¥:', error.message);
            if (error.response) {
              console.error('HTTPçŠ¶æ€:', error.response.status);
              console.error('å“åº”æ•°æ®:', error.response.data);
            }
            process.exit(1);
          }
        }
        
        testWXpusher();
        EOF
        
    - name: Run simple WXpusher test
      env:
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
      run: |
        echo "## ðŸ“‹ æµ‹è¯•æ‰§è¡Œæ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        node test-wxpusher-simple.js 2>&1 | tee /tmp/test-output.log
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æµ‹è¯•ç»“æžœ
        if [ $? -eq 0 ]; then
          echo "## âœ… æµ‹è¯•å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æŸ¥æ‚¨çš„å¾®ä¿¡æ˜¯å¦æ”¶åˆ°æµ‹è¯•æ¶ˆæ¯" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ æµ‹è¯•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: simple-wxpusher-test-logs
        path: /tmp/test-output.log
        retention-days: 3