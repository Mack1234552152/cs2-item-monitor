name: CS2 Single Item Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      item_name:
        description: 'é¥°å“åç§°'
        required: false
        default: 'M4A4 | æ´»è‰²ç”Ÿé¦™'
        type: string
      item_id:
        description: 'é¥°å“ID'
        required: false
        default: '13283'
        type: string

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get current IP
      id: get-ip
      run: |
        current_ip=$(curl -s ifconfig.me)
        echo "Current IP: $current_ip"
        echo "IP=$current_ip" >> $GITHUB_OUTPUT
        
    - name: Set item info
      id: item-info
      run: |
        # ä½¿ç”¨è¾“å…¥å‚æ•°æˆ–é»˜è®¤å€¼
        item_name="${{ github.event.inputs.item_name || 'M4A4 | æ´»è‰²ç”Ÿé¦™ (å´­æ–°å‡ºå‚)' }}"
        item_id="${{ github.event.inputs.item_id || '13283' }}"
        
        echo "Item Name: $item_name"
        echo "Item ID: $item_id"
        echo "NAME=$item_name" >> $GITHUB_OUTPUT
        echo "ID=$item_id" >> $GITHUB_OUTPUT
        
    - name: Bind IP to CSQAQ
      run: |
        echo "Binding IP: ${{ steps.get-ip.outputs.IP }}"
        
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/sys/bind_local_ip" \
          -H "Content-Type: application/json" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0")
        
        echo "IP binding response: $response"
        
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… IP binding successful!"
        else
          echo "âŒ IP binding failed"
          exit 1
        fi
        
    - name: Wait for IP binding
      run: |
        echo "Waiting 20 seconds for IP binding to take effect..."
        sleep 20
        
    - name: Get Single Item Data
      run: |
        echo "Fetching data for: ${{ steps.item-info.outputs.NAME }}"
        
        # ä½¿ç”¨CSQAQçš„çƒ­é—¨æ’è¡ŒAPIæ¥è·å–ç‰¹å®šé¥°å“ä¿¡æ¯
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/goods/hot_rank" \
          -H "Content-Type: application/json" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -d '{
            "page": 1,
            "page_size": 50
          }')
        
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… Data fetch successful!"
          
          # ä»çƒ­é—¨æ’è¡Œä¸­æŸ¥æ‰¾æŒ‡å®šé¥°å“
          item_data=$(echo "$response" | grep -o "{[^}]*\"goods_id\":${{ steps.item-info.outputs.ID }}[^}]*}" | head -1)
          
          if [ -n "$item_data" ]; then
            echo "Found item data!"
            
            # è§£æä»·æ ¼ä¿¡æ¯
            price=$(echo "$item_data" | grep -o '"price":[^,}]*' | cut -d':' -f2 | tr -d '" ')
            name=$(echo "$item_data" | grep -o '"name":"[^"]*"' | cut -d':' -f2 | tr -d '" ')
            change_24h=$(echo "$item_data" | grep -o '"change_24h":[^,}]*' | cut -d':' -f2 | tr -d '" ')
            
            echo "Name: $name"
            echo "Price: $price"
            echo "24h Change: $change_24h%"
            
            # æ„å»ºé€šçŸ¥å†…å®¹
            notification_content="CS2é¥°å“ç›‘æ§ - ${{ steps.item-info.outputs.NAME }}

å½“å‰ä»·æ ¼: Â¥$price
24å°æ—¶å˜åŒ–: $change_24h%
æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
ç›‘æ§IP: ${{ steps.get-ip.outputs.IP }}

é¥°å“ID: ${{ steps.item-info.outputs.ID }}"
            
            # å‘é€é€šçŸ¥
            curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
              -H "Content-Type: application/json" \
              -d "{
                \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
                \"content\": \"$notification_content\",
                \"summary\": \"CS2é¥°å“: ${{ steps.item-info.outputs.NAME }}\",
                \"contentType\": 1,
                \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
              }"
            
            echo "âœ… Notification sent successfully!"
          else
            echo "âŒ Item not found in hot ranking"
            
            # å‘é€æœªæ‰¾åˆ°é€šçŸ¥
            error_content="CS2ç›‘æ§ - é¥°å“æœªæ‰¾åˆ°

é¥°å“: ${{ steps.item-info.outputs.NAME }}
ID: ${{ steps.item-info.outputs.ID }}
æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

å¯èƒ½åŸå› : é¥°å“ä¸åœ¨çƒ­é—¨æ’è¡Œä¸­"
            
            curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
              -H "Content-Type: application/json" \
              -d "{
                \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
                \"content\": \"$error_content\",
                \"summary\": \"CS2é¥°å“æœªæ‰¾åˆ°\",
                \"contentType\": 1,
                \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
              }"
          fi
        else
          echo "âŒ API request failed"
          
          # å‘é€APIå¤±è´¥é€šçŸ¥
          error_content="CS2ç›‘æ§ - APIè¯·æ±‚å¤±è´¥

é¥°å“: ${{ steps.item-info.outputs.NAME }}
æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
IP: ${{ steps.get-ip.outputs.IP }}

è¯·æ£€æŸ¥API Tokenæ˜¯å¦æœ‰æ•ˆ"
          
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$error_content\",
              \"summary\": \"CS2ç›‘æ§APIå¤±è´¥\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          exit 1
        fi
        
    - name: Status Report
      if: always()
      run: |
        echo "ğŸ“Š ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š:"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“ æœåŠ¡å™¨IP: ${{ steps.get-ip.outputs.IP }}"
        echo "ğŸ”« ç›‘æ§é¥°å“: ${{ steps.item-info.outputs.NAME }}"
        echo "ğŸ†” é¥°å“ID: ${{ steps.item-info.outputs.ID }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ä»»åŠ¡çŠ¶æ€: æˆåŠŸå®Œæˆ"
        else
          echo "âŒ ä»»åŠ¡çŠ¶æ€: æ‰§è¡Œå¤±è´¥"
        fi