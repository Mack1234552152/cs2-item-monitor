name: CS2 Advanced Price Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 9 * * *'   # æ¯å¤©ä¸Šåˆ9ç‚¹é¢å¤–è¿è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ (ä»…å‘é€ç®€çŸ­é€šçŸ¥)'
        required: false
        default: 'false'
        type: boolean

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm init -y
        echo 'å·²å®ŒæˆNode.jsç¯å¢ƒè®¾ç½®'
        
    - name: Get current IP and debug info
      id: debug
      run: |
        echo "ğŸ” è·å–è¿è¡Œç¯å¢ƒä¿¡æ¯..."
        current_ip=$(curl -s ifconfig.me)
        location=$(curl -s ipinfo.io/city)
        echo "ğŸ“ å½“å‰IP: $current_ip"
        echo "ğŸŒ ä½ç½®: $location"
        echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ip=$current_ip" >> $GITHUB_OUTPUT
        echo "location=$location" >> $GITHUB_OUTPUT
        
    - name: Check CSQAQ API Token
      run: |
        if [ -z "${{ secrets.CSQAQ_API_TOKEN }}" ]; then
          echo "âŒ é”™è¯¯: CSQAQ_API_TOKEN æœªè®¾ç½®"
          echo "è¯·åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ  CSQAQ_API_TOKEN secret"
          exit 1
        else
          echo "âœ… CSQAQ API Token å·²è®¾ç½®"
          echo "Tokenå‰ç¼€: ${{ secrets.CSQAQ_API_TOKEN }}:0:8"
        fi
        
    - name: Bind IP to CSQAQ
      run: |
        echo "ğŸ”— æ­£åœ¨ç»‘å®šIPåˆ°CSQAQ..."
        echo "IP: ${{ steps.debug.outputs.ip }}"
        
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/sys/bind_local_ip" \
          -H "Content-Type: application/json" \
          -H "ApiToken: ${{ secrets.CSQAQ_API_TOKEN }}")
        
        echo "IPç»‘å®šå“åº”: $response"
        
        # æ£€æŸ¥ç»‘å®šç»“æœ
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… IPç»‘å®šæˆåŠŸ!"
          bound_ip=$(echo "$response" | grep -o 'å½“å‰ç»‘å®šIPä¸ºï¼š[^"]*' | cut -d'ï¼š' -f2)
          echo "ç»‘å®šIP: $bound_ip"
        else
          echo "âŒ IPç»‘å®šå¤±è´¥"
          echo "Response: $response"
          
          # å‘é€é”™è¯¯é€šçŸ¥
          curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"âŒ CS2ç›‘æ§å¤±è´¥\\n\\nğŸ”§ IPç»‘å®šå¤±è´¥\\nğŸ“ IP: ${{ steps.debug.outputs.ip }}\\nğŸŒ ä½ç½®: ${{ steps.debug.outputs.location }}\\nğŸ• æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\\n\\nå“åº”: $response\",
              \"summary\": \"CS2ç›‘æ§-IPç»‘å®šå¤±è´¥\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          exit 1
        fi
        
    - name: Wait for IP binding to take effect
      run: |
        echo "â³ ç­‰å¾…IPç»‘å®šç”Ÿæ•ˆ (30ç§’)..."
        for i in {30..1}; do
          echo "ç­‰å¾…ä¸­... $i ç§’"
          sleep 1
        done
        echo "âœ… ç­‰å¾…å®Œæˆï¼Œå¼€å§‹è·å–æ•°æ®"
        
    - name: Run CS2 Monitor Script
      run: |
        echo "ğŸš€ è¿è¡ŒCS2ç›‘æ§è„šæœ¬..."
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export CSQAQ_API_TOKEN="${{ secrets.CSQAQ_API_TOKEN }}"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæµ‹è¯•æ¨¡å¼
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ - å‘é€ç®€çŸ­æµ‹è¯•é€šçŸ¥"
          
          # å‘é€æµ‹è¯•é€šçŸ¥
          curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"ğŸ§ª CS2ç›‘æ§æµ‹è¯•\\n\\nâœ… è„šæœ¬è¿è¡Œæ­£å¸¸\\nğŸ“ IP: ${{ steps.debug.outputs.ip }}\\nğŸŒ ä½ç½®: ${{ steps.debug.outputs.location }}\\nğŸ• æµ‹è¯•æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\",
              \"summary\": \"CS2ç›‘æ§æµ‹è¯•\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
        else
          echo "ğŸ“Š æ­£å¸¸ç›‘æ§æ¨¡å¼ - è·å–é¥°å“æ•°æ®"
          
          # è¿è¡ŒNode.jsç›‘æ§è„šæœ¬
          node scripts/cs2-monitor.js
        fi
        
    - name: System Info and Cleanup
      if: always()
      run: |
        echo "ğŸ“Š ä»»åŠ¡æ‰§è¡Œä¿¡æ¯:"
        echo "â° å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ–¥ï¸ è¿è¡Œå™¨: ${{ runner.os }}"
        echo "ğŸ“ IP: ${{ steps.debug.outputs.ip }}"
        echo "ğŸŒ ä½ç½®: ${{ steps.debug.outputs.location }}"
        echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨: $(df -h .)"
        echo "ğŸ”§ å†…å­˜ä½¿ç”¨: $(free -h)"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ä»»åŠ¡çŠ¶æ€: æˆåŠŸå®Œæˆ"
        else
          echo "âŒ ä»»åŠ¡çŠ¶æ€: æ‰§è¡Œå¤±è´¥"
          
          # å‘é€å¤±è´¥é€šçŸ¥
          curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"âŒ CS2ç›‘æ§ä»»åŠ¡å¤±è´¥\\n\\nğŸ”§ çŠ¶æ€: ${{ job.status }}\\nğŸ“ IP: ${{ steps.debug.outputs.ip }}\\nğŸŒ ä½ç½®: ${{ steps.debug.outputs.location }}\\nğŸ• å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\\n\\nè¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—\",
              \"summary\": \"CS2ç›‘æ§å¤±è´¥\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
        fi
        
    - name: Success Summary
      if: success()
      run: |
        echo "ğŸ‰ CS2é¥°å“ä»·æ ¼ç›‘æ§ä»»åŠ¡æˆåŠŸå®Œæˆ!"
        echo "ğŸ“Š æœ¬æ¬¡ç›‘æ§åŒ…å«:"
        echo "   â€¢ IPç»‘å®šå’ŒéªŒè¯"
        echo "   â€¢ å¤šä¸ªé¥°å“ä»·æ ¼è·å–"
        echo "   â€¢ çƒ­é—¨é¥°å“æ’è¡Œ"
        echo "   â€¢ WXpusheré€šçŸ¥å‘é€"
        echo "âœ… æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæ¯•"