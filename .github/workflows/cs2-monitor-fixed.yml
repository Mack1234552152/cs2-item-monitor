name: CS2 Price Monitor - Fixed with IP Binding

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Get current IP address
      id: ip
      run: |
        current_ip=$(curl -s ifconfig.me)
        echo "Current IP: $current_ip"
        echo "IP=$current_ip" >> $GITHUB_OUTPUT
        
    - name: Bind IP to CSQAQ
      run: |
        echo "æ­£åœ¨ç»‘å®šIP: ${{ steps.ip.outputs.IP }}"
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/sys/bind_local_ip" \
          -H "Content-Type: application/json" \
          -H "ApiToken: ${{ secrets.CSQAQ_API_TOKEN }}")
        
        echo "IPç»‘å®šå“åº”: $response"
        
        # ç­‰å¾…ç»‘å®šç”Ÿæ•ˆ
        echo "ç­‰å¾…30ç§’è®©IPç»‘å®šç”Ÿæ•ˆ..."
        sleep 30
        
    - name: Test CSQAQ API Connection
      run: |
        echo "æµ‹è¯•CSQAQ APIè¿æ¥..."
        
        # å…ˆå°è¯•è·å–é¦–é¡µæ•°æ®ï¼ˆæœ€ç®€å•çš„æ¥å£ï¼‰
        response=$(curl -s -X GET "https://api.csqaq.com/api/v1/index/home" \
          -H "ApiToken: ${{ secrets.CSQAQ_API_TOKEN }}")
          
        echo "é¦–é¡µAPIå“åº”: $response"
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… CSQAQ APIè¿æ¥æˆåŠŸ!"
        else
          echo "âŒ CSQAQ APIè¿æ¥å¤±è´¥"
          echo "Response: $response"
        fi
        
    - name: Fetch Specific CS2 Item Data
      run: |
        echo "è·å–ç‰¹å®šé¥°å“æ•°æ®..."
        
        # è·å–M4A4 | æ´»è‰²ç”Ÿé¦™ (å´­æ–°å‡ºå‚) çš„æ•°æ®
        item_data=$(curl -s -X GET "https://api.csqaq.com/api/v1/goods/detail?goods_id=13283" \
          -H "ApiToken: ${{ secrets.CSQAQ_API_TOKEN }}")
          
        echo "é¥°å“æ•°æ®å“åº”: $item_data"
        
        # è§£æä»·æ ¼æ•°æ®
        if echo "$item_data" | grep -q '"code":200'; then
          echo "âœ… é¥°å“æ•°æ®è·å–æˆåŠŸ!"
          
          # æå–ä»·æ ¼ä¿¡æ¯ï¼ˆJSONè§£æï¼‰
          price=$(echo "$item_data" | grep -o '"price":[^,]*' | cut -d':' -f2 | tr -d '"' | tr -d ' ')
          echo "å½“å‰ä»·æ ¼: $price"
          
          # å‘é€é€šçŸ¥
          notification_content="ğŸ”« CS2é¥°å“ä»·æ ¼ç›‘æ§\n\nğŸ“Š M4A4 | æ´»è‰²ç”Ÿé¦™ (å´­æ–°å‡ºå‚)\nğŸ’° å½“å‰ä»·æ ¼: Â¥$price\nğŸ• æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\nğŸ“ æœåŠ¡å™¨IP: ${{ steps.ip.outputs.IP }}"
          
          curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$notification_content\",
              \"summary\": \"CS2é¥°å“ä»·æ ¼æ›´æ–°\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
            
          echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ!"
        else
          echo "âŒ é¥°å“æ•°æ®è·å–å¤±è´¥"
          
          # å‘é€é”™è¯¯é€šçŸ¥
          error_content="âŒ CS2é¥°å“ç›‘æ§å¤±è´¥\n\nğŸ”§ é”™è¯¯ä¿¡æ¯: é¥°å“æ•°æ®è·å–å¤±è´¥\nğŸ“ æœåŠ¡å™¨IP: ${{ steps.ip.outputs.IP }}\nğŸ• å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\n\nAPIå“åº”: $item_data"
          
          curl -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$error_content\",
              \"summary\": \"CS2ç›‘æ§å¤±è´¥\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
        fi
        
    - name: Summary
      run: |
        echo "ğŸ¯ CS2é¥°å“ç›‘æ§ä»»åŠ¡å®Œæˆ!"
        echo "ğŸ“ ä½¿ç”¨çš„IP: ${{ steps.ip.outputs.IP }}"
        echo "â° å®Œæˆæ—¶é—´: $(date)"