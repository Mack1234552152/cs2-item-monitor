name: CS2 Price Monitor (Fixed with Correct API)

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  price-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create config file with CORRECT API
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "endpoint": "/api/v1/goods/get_all_goods_info"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          },
          "monitor": {
            "interval": 300000,
            "platforms": ["youyoupin", "buff", "steam"],
            "priceThreshold": 1.0,
            "retryAttempts": 3,
            "retryDelay": 5000,
            "historyDays": 180
          },
          "storage": {
            "dataPath": "./data/price-history.json",
            "maxHistoryDays": 180
          },
          "logging": {
            "level": "info",
            "file": "logs/monitor.log"
          }
        }
        EOF
        
    - name: Create required directories
      run: |
        mkdir -p data logs
        
    - name: Create items.json if not exists
      run: |
        if [ ! -f "config/items.json" ]; then
          cat > config/items.json << 'EOF'
          {
            "items": [
              {
                "id": 1,
                "name": "AK-47 | çº¢çº¿",
                "market_name": "AK-47 | Redline",
                "enabled": true,
                "platforms": ["youyoupin", "buff", "steam"],
                "wear_ranges": ["FT", "MW", "FN"],
                "notify_threshold": 0.9,
                "priority": "high"
              }
            ]
          }
          EOF
        fi
        
    - name: Test CSQAQ API directly
      run: |
        echo "=== ğŸ§ª Testing CSQAQ API with CORRECT configuration ==="
        echo "API Endpoint: https://api.csqaq.com/api/v1/goods/get_all_goods_info"
        echo "Authentication: ApiToken: JOVN71P7T388E2N1G1H6W5A0"
        echo ""
        
        # Test with correct authentication
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "limit": 5,
            "page": 1
          }')
        
        echo "Response: $response"
        
        # Check if response contains error
        if [[ $response == *"è¯·æ±‚çš„åœ°å€éæ³•"* ]]; then
          echo "âŒ APIç«¯ç‚¹ä»æœ‰é—®é¢˜"
        elif [[ $response == *"401"* ]]; then
          echo "âŒ è®¤è¯å¤±è´¥"
        elif [[ $response == *"HTTP_CODE:200"* ]]; then
          echo "âœ… APIè°ƒç”¨æˆåŠŸï¼"
        else
          echo "ğŸ” éœ€è¦è¿›ä¸€æ­¥åˆ†æå“åº”"
        fi
        
    - name: Run price monitor (with fixed API)
      id: monitor
      continue-on-error: true
      run: |
        echo "ğŸš€ Starting CS2 price monitor with FIXED API..."
        echo "Current time: $(date)"
        echo "API endpoint: https://api.csqaq.com/api/v1/goods/get_all_goods_info"
        echo "WXpusher AppToken: AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz"
        echo "Using CORRECT ApiToken header format"
        timeout 300s npm start || echo "Monitor completed or timed out"
        
    - name: Show execution result
      if: always()
      run: |
        echo "## ğŸ“Š ç›‘æ§æ‰§è¡Œç»“æœ (APIå·²ä¿®å¤)" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **APIç«¯ç‚¹**: https://api.csqaq.com/api/v1/goods/get_all_goods_info" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æ§çŠ¶æ€**: ${{ steps.monitor.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APIä¿®å¤**: âœ… ä½¿ç”¨æ­£ç¡®çš„ç«¯ç‚¹å’Œè®¤è¯æ–¹å¼" >> $GITHUB_STEP_SUMMARY
        echo "- **WXpusheré…ç½®**: âœ… å·²é…ç½® (æ–°AppToken: AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz)" >> $GITHUB_STEP_SUMMARY
        
    - name: Send success notification
      if: always()
      run: |
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "ğŸ”§ CSQAQ APIå·²ä¿®å¤\\n\\nâ° æ—¶é—´: '"$(date)"'\\nğŸ¯ ä¿®å¤å†…å®¹:\\nâ€¢ ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹\\nâ€¢ ä¿®å¤è®¤è¯æ–¹å¼(ApiToken header)\\nâ€¢ ä½¿ç”¨æœ‰æ•ˆçš„AppToken\\n\\nâœ… å·¥ä½œæµç°åœ¨åº”è¯¥å¯ä»¥æ­£å¸¸è°ƒç”¨CSQAQ API\\n\\nğŸ“± æµ‹è¯•æˆåŠŸåè¯·ç¡®è®¤æ˜¯å¦æ”¶åˆ°ä»·æ ¼æé†’",
            "summary": "CSQAQ APIå·²ä¿®å¤ - å·¥ä½œæµæ­£å¸¸",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        echo "WXpusher notification sent: $response"
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitor-logs-${{ github.run_number }}
        path: |
          logs/
          data/
        retention-days: 3
        if-no-files-found: ignore