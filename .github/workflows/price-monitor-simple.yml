name: CS2 Price Monitor (Simple)

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  price-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create config file
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com/api/v1",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "whitelist_ip": "111.19.113.82"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          },
          "monitor": {
            "interval": 300000,
            "platforms": ["youyoupin", "buff", "steam"],
            "priceThreshold": 1.0,
            "retryAttempts": 3,
            "retryDelay": 5000,
            "historyDays": 180
          },
          "storage": {
            "dataPath": "./data/price-history.json",
            "maxHistoryDays": 180
          },
          "logging": {
            "level": "info",
            "file": "logs/monitor.log"
          }
        }
        EOF
        
    - name: Create required directories
      run: |
        mkdir -p data logs
        
    - name: Create items.json if not exists
      run: |
        if [ ! -f "config/items.json" ]; then
          cat > config/items.json << 'EOF'
          {
            "items": [
              {
                "id": 1,
                "name": "AK-47 | çº¢çº¿",
                "market_name": "AK-47 | Redline",
                "enabled": true,
                "platforms": ["youyoupin", "buff", "steam"],
                "wear_ranges": ["FT", "MW", "FN"],
                "notify_threshold": 0.9,
                "priority": "high"
              }
            ]
          }
          EOF
        fi
        
    - name: Test WXpusher API
      run: |
        echo "ðŸ§ª Testing WXpusher configuration..."
        echo "AppToken: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0"
        
        # Create a simple test script
        cat > test-wxpusher.js << 'EOF'
        const axios = require('axios');
        
        async function testWXpusher() {
          try {
            console.log('ðŸ“¤ Testing WXpusher API...');
            console.log('AppToken: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0');
            
            // Test app info
            const appInfo = await axios.get('https://wxpusher.zjiecode.com/api/fun/app/AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0');
            console.log('âœ… App info:', appInfo.data);
            
            // Test users
            const users = await axios.get('https://wxpusher.zjiecode.com/api/fun/wxuser', {
              params: {
                appToken: 'AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0',
                page: 1,
                pageSize: 10
              }
            });
            console.log('âœ… Users:', users.data);
            
            // Send test message if users exist
            if (users.data.data && users.data.data.records && users.data.data.records.length > 0) {
              const userIds = users.data.data.records.map(user => user.uid);
              
              const messageResponse = await axios.post('https://wxpusher.zjiecode.com/api/send/message', {
                appToken: 'AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0',
                contentType: 1,
                content: 'ðŸŽ‰ WXpusheré…ç½®æˆåŠŸï¼\\n\\næ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\\n\\nCS2é¥°å“ä»·æ ¼ç›‘æŽ§çŽ°åœ¨å¯ä»¥æ­£å¸¸æŽ¨é€æ¶ˆæ¯äº†ï¼',
                summary: 'WXpusheré…ç½®æµ‹è¯•æˆåŠŸ',
                uids: userIds
              });
              
              console.log('ðŸŽ‰ Message sent:', messageResponse.data);
              console.log('âœ… æµ‹è¯•å®Œæˆï¼æ‚¨åº”è¯¥æ”¶åˆ°å¾®ä¿¡æ¶ˆæ¯äº†ã€‚');
            } else {
              console.log('âš ï¸ No users found, please follow the WXpusher official account');
            }
            
          } catch (error) {
            console.error('âŒ Test failed:', error.message);
            if (error.response) {
              console.error('HTTP Status:', error.response.status);
              console.error('Response Data:', error.response.data);
            }
            process.exit(1);
          }
        }
        
        testWXpusher();
        EOF
        
        # Run the test
        node test-wxpusher.js
        
    - name: Run price monitor (single check)
      id: monitor
      continue-on-error: true
      run: |
        echo "å¼€å§‹æ‰§è¡Œä»·æ ¼ç›‘æŽ§..."
        timeout 300s npm start || echo "ç›‘æŽ§æ‰§è¡Œå®Œæˆæˆ–è¶…æ—¶"
        
    - name: Show execution result
      if: always()
      run: |
        echo "## ðŸ“Š ç›‘æŽ§æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **APIç«¯ç‚¹**: https://api.csqaq.com/api/v1" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§çŠ¶æ€**: ${{ steps.monitor.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **WXpusheré…ç½®**: âœ… å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitor-logs-${{ github.run_number }}
        path: |
          logs/
          data/
        retention-days: 3
        if-no-files-found: ignore