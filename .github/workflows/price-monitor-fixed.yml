name: CS2 Price Monitor (Fixed)

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  price-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create required directories
      run: |
        mkdir -p data logs config
        
    - name: Create config file
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com/api/v1",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "whitelist_ip": "111.19.113.82"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          },
          "monitor": {
            "interval": 300000,
            "platforms": ["youyoupin", "buff", "steam"],
            "priceThreshold": 1.0,
            "retryAttempts": 3,
            "retryDelay": 5000,
            "historyDays": 180
          },
          "storage": {
            "dataPath": "./data/price-history.json",
            "maxHistoryDays": 180
          },
          "logging": {
            "level": "info",
            "file": "logs/monitor.log"
          }
        }
        EOF
        
    - name: Create items.json
      run: |
        cat > config/items.json << 'EOF'
        {
          "items": [
            {
              "id": 1,
              "name": "AK-47 | çº¢çº¿",
              "market_name": "AK-47 | Redline",
              "enabled": true,
              "platforms": ["youyoupin", "buff", "steam"],
              "wear_ranges": ["FT", "MW", "FN"],
              "notify_threshold": 0.9,
              "priority": "high"
            }
          ]
        }
        EOF
        
    - name: Test WXpusher API first
      run: |
        echo "ðŸ§ª æµ‹è¯•WXpusher APIè¿žæŽ¥..."
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj",
            "content": "ðŸ”„ CS2ä»·æ ¼ç›‘æŽ§ç³»ç»Ÿå¯åŠ¨\n\nâ° æ—¶é—´: '"$(date)"'\nðŸ”§ æ­£åœ¨åˆå§‹åŒ–ç›‘æŽ§æœåŠ¡...',
            "summary": "CS2ç›‘æŽ§å¯åŠ¨",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        if echo "$response" | grep -q '"code":1000'; then
          echo "âœ… WXpusher APIæµ‹è¯•æˆåŠŸ"
        else
          echo "âŒ WXpusher APIæµ‹è¯•å¤±è´¥: $response"
          echo "ç»§ç»­æ‰§è¡Œä»·æ ¼ç›‘æŽ§..."
        fi
        
    - name: Test CSQAQ API
      run: |
        echo "ðŸ” æµ‹è¯•CSQAQ APIè¿žæŽ¥..."
        response=$(curl -s -X GET "https://api.csqaq.com/api/v1/items?limit=1" \
          -H "Authorization: Bearer JOVN71P7T388E2N1G1H6W5A0")
        
        if echo "$response" | grep -q '"success":true\|data'; then
          echo "âœ… CSQAQ APIè¿žæŽ¥æ­£å¸¸"
        else
          echo "âŒ CSQAQ APIè¿žæŽ¥å¤±è´¥: $response"
          echo "ç»§ç»­æ‰§è¡Œ..."
        fi
        
    - name: Run simple monitor test
      run: |
        echo "ðŸš€ å¯åŠ¨ç®€åŒ–ç‰ˆä»·æ ¼ç›‘æŽ§..."
        echo "å¼€å§‹æ—¶é—´: $(date)"
        
        # åˆ›å»ºç®€åŒ–çš„ç›‘æŽ§è„šæœ¬
        cat > simple-monitor.js << 'EOF'
        const axios = require('axios');
        const fs = require('fs');
        const path = require('path');
        
        async function testMonitor() {
          try {
            console.log('ðŸ” å¼€å§‹ä»·æ ¼æ£€æŸ¥...');
            
            // æµ‹è¯•CSQAQ API
            const apiResponse = await axios.get('https://api.csqaq.com/api/v1/items?limit=1', {
              headers: {
                'Authorization': 'Bearer JOVN71P7T388E2N1G1H6W5A0'
              }
            });
            
            console.log('âœ… APIè¿žæŽ¥æˆåŠŸ');
            
            // å‘é€æµ‹è¯•é€šçŸ¥
            const wxResponse = await axios.post('https://wxpusher.zjiecode.com/api/send/message', {
              appToken: 'AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj',
              content: `ðŸŽ¯ CS2ä»·æ ¼ç›‘æŽ§ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼\n\nâ° æ£€æŸ¥æ—¶é—´: ${new Date().toLocaleString()}\nâœ… APIçŠ¶æ€: æ­£å¸¸\nðŸ“Š ç›‘æŽ§çŠ¶æ€: è¿è¡Œä¸­\n\nðŸ”§ AppToken: AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj`,
              summary: 'CS2ç›‘æŽ§æ­£å¸¸è¿è¡Œ',
              contentType: 1,
              uids: ['UID_Nkv98Q7XEQcDsvSInIlR10nm33xI']
            });
            
            console.log('ðŸ“± é€šçŸ¥å‘é€ç»“æžœ:', wxResponse.data);
            
            if (wxResponse.data.code === 1000) {
              console.log('âœ… ç›‘æŽ§æµ‹è¯•å®Œæˆ - ä¸€åˆ‡æ­£å¸¸ï¼');
              return true;
            } else {
              console.log('âŒ é€šçŸ¥å‘é€å¤±è´¥:', wxResponse.data);
              return false;
            }
            
          } catch (error) {
            console.error('âŒ ç›‘æŽ§æµ‹è¯•å¤±è´¥:', error.message);
            return false;
          }
        }
        
        // è¿è¡Œæµ‹è¯•
        testMonitor().then(success => {
          if (success) {
            console.log('ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
            process.exit(0);
          } else {
            console.log('ðŸ’¥ æµ‹è¯•å¤±è´¥ï¼');
            process.exit(1);
          }
        });
        EOF
        
        # è¿è¡Œç®€åŒ–ç›‘æŽ§è„šæœ¬
        node simple-monitor.js
        
    - name: Show results
      if: always()
      run: |
        echo "## ðŸ“Š ç›‘æŽ§æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **AppToken**: AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§çŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ­¥éª¤çŠ¶æ€**: ${{ steps.*.outcome }}" >> $GITHUB_STEP_SUMMARY