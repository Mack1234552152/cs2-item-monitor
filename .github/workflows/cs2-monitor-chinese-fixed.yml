name: CS2ä¸­æ–‡ä»·æ ¼ç›‘æŽ§ (å·²ä¿®å¤)

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  chinese-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - name: èŽ·å–å½“å‰IPåœ°å€
      id: ip
      run: |
        IP=$(curl -s https://ipinfo.io/ip)
        echo "current_ip=$IP" >> $GITHUB_OUTPUT
        echo "å½“å‰IP: $IP"
        
    - name: ç»‘å®šIPåˆ°CSQAQ
      run: |
        echo "=== ðŸ”— ç»‘å®šIPåˆ°CSQAQ API ==="
        echo "IPåœ°å€: ${{ steps.ip.outputs.current_ip }}"
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/auth/bind_ip" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d "{
            \"ip_address\": \"${{ steps.ip.outputs.current_ip }}\",
            \"remark\": \"GitHub Actionsä¸­æ–‡ç›‘æŽ§ - $(date)\"
          }")
        
        echo "IPç»‘å®šå“åº”: $response"
        
    - name: ç­‰å¾…IPç»‘å®šç”Ÿæ•ˆ
      run: |
        echo "ç­‰å¾…10ç§’è®©IPç»‘å®šç”Ÿæ•ˆ..."
        sleep 10
        
    - name: èŽ·å–AK-47çº¢çº¿ä»·æ ¼æ•°æ®
      id: price_data
      run: |
        echo "=== ðŸ“Š èŽ·å–AK-47çº¢çº¿ä»·æ ¼æ•°æ® ==="
        
        # ä½¿ç”¨æœç´¢åŠŸèƒ½èŽ·å–AK-47çº¢çº¿æ•°æ®
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47",
            "limit": 5,
            "page": 1
          }')
        
        echo "APIå®Œæ•´å“åº”: $response"
        
        # æå–å…³é”®ä¿¡æ¯ç”¨äºŽé€šçŸ¥
        if [[ $response == *"price"* ]] || [[ $response == *"Steam"* ]]; then
          echo "found_data=true" >> $GITHUB_OUTPUT
          echo "âœ… æˆåŠŸèŽ·å–ä»·æ ¼æ•°æ®"
        else
          echo "found_data=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ æ•°æ®èŽ·å–æœ‰é—®é¢˜ï¼Œä½†ç»§ç»­å‘é€é€šçŸ¥"
        fi
        
    - name: èŽ·å–æ‚ æ‚ æœ‰å“å…·ä½“ä»·æ ¼
      id: youyoupin_data
      run: |
        echo "=== ðŸ›’ èŽ·å–æ‚ æ‚ æœ‰å“ä»·æ ¼ ==="
        
        # å°è¯•èŽ·å–æ‚ æ‚ æœ‰å“çš„AK-47çº¢çº¿æ•°æ®
        response=$(curl -s \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47",
            "platform": "youyoupin",
            "limit": 3,
            "page": 1
          }')
        
        echo "æ‚ æ‚ æœ‰å“å“åº”: $response"
        
        # æå–ä»·æ ¼ä¿¡æ¯
        if [[ $response == *"youyoupin_price"* ]]; then
          echo "has_youyoupin=true" >> $GITHUB_OUTPUT
          # ç®€å•æå–ä»·æ ¼æ•°å­—
          price=$(echo "$response" | grep -o '"youyoupin_price":[0-9.]*' | cut -d':' -f2)
          if [[ ! -z "$price" ]]; then
            echo "youyoupin_price=$price" >> $GITHUB_OUTPUT
            echo "æ‚ æ‚ æœ‰å“ä»·æ ¼: Â¥$price"
          fi
        else
          echo "has_youyoupin=false" >> $GITHUB_OUTPUT
          echo "æ— æ³•èŽ·å–æ‚ æ‚ æœ‰å“ä»·æ ¼"
        fi
        
    - name: èŽ·å–BUFFä»·æ ¼
      id: buff_data
      run: |
        echo "=== ðŸŽ® èŽ·å–BUFFä»·æ ¼ ==="
        
        response=$(curl -s \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47",
            "platform": "buff",
            "limit": 3,
            "page": 1
          }')
        
        echo "BUFFå“åº”: $response"
        
        if [[ $response == *"buff_price"* ]]; then
          echo "has_buff=true" >> $GITHUB_OUTPUT
          price=$(echo "$response" | grep -o '"buff_price":[0-9.]*' | cut -d':' -f2)
          if [[ ! -z "$price" ]]; then
            echo "buff_price=$price" >> $GITHUB_OUTPUT
            echo "BUFFä»·æ ¼: Â¥$price"
          fi
        else
          echo "has_buff=false" >> $GITHUB_OUTPUT
          echo "æ— æ³•èŽ·å–BUFFä»·æ ¼"
        fi
        
    - name: å‘é€ä¸­æ–‡é¥°å“ä»·æ ¼ç›‘æŽ§é€šçŸ¥
      run: |
        echo "=== ðŸ“± å‘é€ä¸­æ–‡é¥°å“ä»·æ ¼ç›‘æŽ§é€šçŸ¥ ==="
        echo "ç›‘æŽ§æ—¶é—´: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')"
        echo "å½“å‰IP: ${{ steps.ip.outputs.current_ip }}"
        
        # æž„å»ºä»·æ ¼ä¿¡æ¯
        youyoupin_price="${{ steps.youyoupin.outputs.youyoupin_price || 'N/A' }}"
        buff_price="${{ steps.buff_data.outputs.buff_price || 'N/A' }}"
        
        # å‘é€ä¸­æ–‡é€šçŸ¥
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "ðŸ”« CS2é¥°å“ä»·æ ¼ç›‘æŽ§\n\nâ° ç›‘æŽ§æ—¶é—´: '$(date +%Yå¹´%mæœˆ%dæ—¥\ %H:%M:%S)'\nðŸ“ å½“å‰IP: ${{ steps.ip.outputs.current_ip }}\nðŸŽ¯ ç›‘æŽ§é¥°å“: AK-47 | çº¢çº¿\n\nðŸ“Š å„å¹³å°ä»·æ ¼:\nðŸ›’ æ‚ æ‚ æœ‰å“: ${{ steps.youyoupin.outputs.youyoupin_price || '' }}å…ƒ\nðŸŽ® BUFF: ${{ steps.buff_data.outputs.buff_price || '' }}å…ƒ\nðŸš‚ Steam: APIæŸ¥è¯¢ä¸­...\n\nðŸª æ•°æ®æ¥æº: CSQAQå®˜æ–¹API\nâœ… ç›‘æŽ§çŠ¶æ€: æ­£å¸¸è¿è¡Œ\nðŸ“… ä¸‹æ¬¡æ£€æŸ¥: '$(date -d '+30 minutes' +%H:%M')'",
            "summary": "CS2é¥°å“ç›‘æŽ§ - AK-47çº¢çº¿",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        echo "WXpusherå“åº”: $response"
        
        # æ£€æŸ¥ç»“æžœ
        if [[ $response == *"code":1000* ]]; then
          echo "âœ… ä¸­æ–‡ç›‘æŽ§é€šçŸ¥å‘é€æˆåŠŸ!"
        else
          echo "âŒ ä¸­æ–‡ç›‘æŽ§é€šçŸ¥å‘é€å¤±è´¥"
          echo "å“åº”: $response"
        fi
        
    - name: æ‰§è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸ“Š ä¸­æ–‡ç›‘æŽ§æ‰§è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **å½“å‰IP**: ${{ steps.ip.outputs.current_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§é¥°å“**: AK-47 | çº¢çº¿" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‚ æ‚ æœ‰å“ä»·æ ¼**: Â¥${{ steps.youyoupin.outputs.youyoupin_price || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **BUFFä»·æ ¼**: Â¥${{ steps.buff_data.outputs.buff_price || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é€šçŸ¥è¯­è¨€**: ä¸­æ–‡" >> $GITHUB_STEP_SUMMARY
        echo "- **é€šçŸ¥çŠ¶æ€**: å·²å‘é€" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§é¢‘çŽ‡**: æ¯30åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY