name: Force WXpusher Test

on:
  workflow_dispatch:
    inputs:
      send_alert:
        description: 'Send WXpusher test message'
        required: false
        default: 'yes'
        type: choice
        options:
          - yes
          - no

jobs:
  test-wxpusher:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create config
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com/api/v1",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "whitelist_ip": "111.19.113.82"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          }
        }
        EOF
        
    - name: Send test message
      if: github.event.inputs.send_alert == 'yes' || github.event.inputs.send_alert == ''
      run: |
        cat > send-test.js << 'EOF'
        const axios = require('axios');
        
        async function sendTestMessage() {
          try {
            console.log('ğŸ§ª Sending WXpusher test message...');
            console.log('AppToken: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0');
            
            // Get users first
            const users = await axios.get('https://wxpusher.zjiecode.com/api/fun/wxuser', {
              params: {
                appToken: 'AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0',
                page: 1,
                pageSize: 10
              }
            });
            
            console.log('ğŸ“‹ Found users:', users.data.data?.records?.length || 0);
            
            if (users.data.data && users.data.data.records && users.data.data.records.length > 0) {
              const userIds = users.data.data.records.map(user => user.uid);
              
              const messageResponse = await axios.post('https://wxpusher.zjiecode.com/api/send/message', {
                appToken: 'AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0',
                contentType: 1,
                content: 'ğŸ§ª WXpusheræµ‹è¯•æ¶ˆæ¯\\n\\næ—¶é—´: ' + new Date().toLocaleString('zh-CN') + '\\n\\nè¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œç”¨äºéªŒè¯WXpusheré…ç½®æ˜¯å¦æ­£ç¡®ï¼',
                summary: 'WXpusheræµ‹è¯•',
                uids: userIds
              });
              
              console.log('âœ… Message sent successfully:', messageResponse.data);
              console.log('ğŸ‰ æ£€æŸ¥æ‚¨çš„å¾®ä¿¡æ˜¯å¦æ”¶åˆ°æ­¤æ¶ˆæ¯ï¼');
            } else {
              console.log('âš ï¸ No users found, please follow WXpusher official account');
            }
            
          } catch (error) {
            console.error('âŒ Failed to send message:', error.message);
            if (error.response) {
              console.error('Response data:', error.response.data);
            }
            process.exit(1);
          }
        }
        
        sendTestMessage();
        EOF
        
        node send-test.js