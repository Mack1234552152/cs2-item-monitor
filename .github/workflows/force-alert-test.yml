name: Force Price Alert Test

on:
  workflow_dispatch:
    inputs:
      send_alert:
        description: 'æ˜¯å¦å‘é€æµ‹è¯•ä»·æ ¼é¢„è­¦'
        required: false
        default: 'yes'
        type: choice
        options:
          - yes
          - no

jobs:
  force-alert-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create config
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com/api/v1",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "whitelist_ip": "111.19.113.82"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "${{ secrets.WXPUSHER_APP_TOKEN }}",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          }
        }
        EOF
        
    - name: Create test alert script
      run: |
        cat > force-test-alert.js << 'EOF'
        const WXPusher = require('./src/notification/wxpusher');
        
        console.log('ðŸ§ª å¼ºåˆ¶è§¦å‘ä»·æ ¼é¢„è­¦æµ‹è¯•...');
        
        const notifier = new WXPusher();
        
        // åˆ›å»ºæµ‹è¯•ä»·æ ¼é¢„è­¦æ•°æ®
        const testAlert = {
          itemName: 'AK-47 | çº¢çº¿ (æµ‹è¯•é¢„è­¦)',
          platform: 'Steamå¸‚åœº',
          currentPrice: 158.50,
          historicalLow: 180.00,
          discount: 0.12, // 12%æŠ˜æ‰£
          url: 'https://example.com/test'
        };
        
        console.log('ðŸ“¤ æµ‹è¯•é¢„è­¦æ•°æ®:');
        console.log('- é¥°å“:', testAlert.itemName);
        console.log('- å¹³å°:', testAlert.platform);
        console.log('- å½“å‰ä»·æ ¼: Â¥' + testAlert.currentPrice);
        console.log('- åŽ†å²æœ€ä½Ž: Â¥' + testAlert.historicalLow);
        console.log('- æŠ˜æ‰£:', (testAlert.discount * 100).toFixed(1) + '%');
        
        async function sendTestAlert() {
          try {
            console.log('ðŸ“± å‘é€æµ‹è¯•ä»·æ ¼é¢„è­¦...');
            
            const result = await notifier.sendPriceAlert(testAlert);
            
            console.log('âœ… ä»·æ ¼é¢„è­¦å‘é€ç»“æžœ:', result);
            
            if (result && result.code === 1000) {
              console.log('ðŸŽ‰ ä»·æ ¼é¢„è­¦å‘é€æˆåŠŸï¼');
              console.log('è¯·æ£€æŸ¥æ‚¨çš„å¾®ä¿¡æ˜¯å¦æ”¶åˆ°é¢„è­¦æ¶ˆæ¯');
            } else {
              console.error('âŒ ä»·æ ¼é¢„è­¦å‘é€å¤±è´¥:', result ? result.msg : 'æœªçŸ¥é”™è¯¯');
            }
            
          } catch (error) {
            console.error('âŒ å‘é€ä»·æ ¼é¢„è­¦æ—¶å‡ºé”™:', error.message);
            
            if (error.response) {
              console.error('HTTPçŠ¶æ€ç :', error.response.status);
              console.error('å“åº”æ•°æ®:', error.response.data);
            }
            
            process.exit(1);
          }
        }
        
        sendTestAlert();
        EOF
        
    - name: Test WXpusher configuration
      run: |
        echo "## ðŸ”§ WXpusheré…ç½®æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        if [ -z "${{ secrets.WXPUSHER_APP_TOKEN }}" ]; then
          echo "âŒ **WXPUSHER_APP_TOKEN æœªé…ç½®**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  WXPUSHER_APP_TOKEN" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **WXPUSHER_APP_TOKEN å·²é…ç½®**" >> $GITHUB_STEP_SUMMARY
          echo "Tokené•¿åº¦: $(echo -n "${{ secrets.WXPUSHER_APP_TOKEN }}" | wc -c) å­—ç¬¦" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Send test alert
      if: github.event.inputs.send_alert == 'yes' || github.event.inputs.send_alert == ''
      env:
        WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
      run: |
        echo "## ðŸ“± å¼ºåˆ¶ä»·æ ¼é¢„è­¦æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æ‰§è¡Œæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        node force-test-alert.js 2>&1 | tee /tmp/alert-test.log
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: force-alert-test-logs-${{ github.run_number }}
        path: /tmp/alert-test.log
        retention-days: 3