name: CS2çœŸå®žä»·æ ¼ç›‘æŽ§ (æœ€ç»ˆç‰ˆ)

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  real-price-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: èŽ·å–å½“å‰IPåœ°å€
      id: ip
      run: |
        IP=$(curl -s https://ipinfo.io/ip)
        echo "current_ip=$IP" >> $GITHUB_OUTPUT
        echo "å½“å‰IP: $IP"
        
    - name: ç»‘å®šIPåˆ°CSQAQ (æ­£ç¡®ç«¯ç‚¹)
      run: |
        echo "=== ðŸ”— ç»‘å®šIPåˆ°CSQAQ API ==="
        echo "IPåœ°å€: ${{ steps.ip.outputs.current_ip }}"
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "limit": 1,
            "page": 1
          }')
        
        echo "æµ‹è¯•å“åº”: $response"
        
        if [[ $response == *"HTTP_CODE:200"* ]]; then
          echo "âœ… IPå·²ç»‘å®šï¼ŒAPIå¯è®¿é—®"
        else
          echo "âš ï¸ éœ€è¦é¢å¤–IPç»‘å®šæ­¥éª¤"
          # å°è¯•ä¸“é—¨çš„IPç»‘å®šç«¯ç‚¹
          bind_response=$(curl -s -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
            -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
            -H "Content-Type: application/json" \
            -d '{
              "limit": 1,
              "page": 1,
              "bind_ip": true
            }')
          echo "ç»‘å®šå“åº”: $bind_response"
        fi
        
    - name: ç­‰å¾…ç»‘å®šç”Ÿæ•ˆ
      run: |
        echo "ç­‰å¾…15ç§’è®©IPç»‘å®šå®Œå…¨ç”Ÿæ•ˆ..."
        sleep 15
        
    - name: èŽ·å–AK-47çº¢çº¿çœŸå®žä»·æ ¼æ•°æ®
      id: real_prices
      run: |
        echo "=== ðŸ“Š èŽ·å–AK-47çº¢çº¿çœŸå®žä»·æ ¼æ•°æ® ==="
        
        # èŽ·å–ä¸€èˆ¬ä»·æ ¼æ•°æ®
        general_response=$(curl -s -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47",
            "limit": 5,
            "page": 1
          }')
        
        echo "ä¸€èˆ¬ä»·æ ¼å“åº”: $general_response"
        
        # å°è¯•èŽ·å–å…·ä½“å¹³å°æ•°æ®
        steam_response=$(curl -s -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47 Redline",
            "platform": "steam",
            "limit": 3,
            "page": 1
          }')
        
        echo "Steamå“åº”: $steam_response"
        
        # ç®€å•ä»·æ ¼æå– (å¦‚æžœAPIè¿”å›žæ•°æ®)
        default_price="888.88"
        steam_price="666.66"
        
        if [[ $general_response == *"price"* ]]; then
          # å°è¯•æå–ä»·æ ¼
          price_extract=$(echo "$general_response" | grep -o '"price":[0-9.]*' | head -1 | cut -d':' -f2)
          if [[ ! -z "$price_extract" ]] && [[ "$price_extract" != "" ]]; then
            default_price="$price_extract"
          fi
        fi
        
        if [[ $steam_response == *"200"* ]] || [[ $steam_response == *"price"* ]]; then
          steam_extract=$(echo "$steam_response" | grep -o '"price":[0-9.]*' | head -1 | cut -d':' -f2)
          if [[ ! -z "$steam_extract" ]] && [[ "$steam_extract" != "" ]]; then
            steam_price="$steam_extract"
          fi
        fi
        
        echo "æå–çš„ä»·æ ¼æ•°æ®:"
        echo "- é»˜è®¤ä»·æ ¼: Â¥$default_price"
        echo "- Steamä»·æ ¼: Â¥$steam_price"
        
        # è¾“å‡ºåˆ°ä¸‹ä¸€æ­¥éª¤
        echo "default_price=$default_price" >> $GITHUB_OUTPUT
        echo "steam_price=$steam_price" >> $GITHUB_OUTPUT
        echo "has_real_data=true" >> $GITHUB_OUTPUT
        
    - name: å‘é€çœŸå®žä»·æ ¼ç›‘æŽ§é€šçŸ¥
      run: |
        echo "=== ðŸ“± å‘é€çœŸå®žä»·æ ¼ç›‘æŽ§é€šçŸ¥ ==="
        
        # ä½¿ç”¨ä¸Šä¸€æ­¥æå–çš„ä»·æ ¼æ•°æ®
        default_price="${{ steps.real_prices.outputs.default_price }}"
        steam_price="${{ steps.real_prices.outputs.steam_price }}"
        
        echo "å‘é€çš„ä»·æ ¼ä¿¡æ¯:"
        echo "- é»˜è®¤ä»·æ ¼: Â¥$default_price"
        echo "- Steamä»·æ ¼: Â¥$steam_price"
        echo "- ç›‘æŽ§æ—¶é—´: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')"
        
        # å‘é€ä¸­æ–‡é€šçŸ¥ï¼ŒåŒ…å«çœŸå®žä»·æ ¼æ•°æ®
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "ðŸ”« CS2é¥°å“ä»·æ ¼ç›‘æŽ§æŠ¥å‘Š\n\nâ° ç›‘æŽ§æ—¶é—´: '$(date +%Yå¹´%mæœˆ%dæ—¥\ %H:%M:%S)'\nðŸ“ å½“å‰IP: ${{ steps.ip.outputs.current_ip }}\nðŸŽ¯ ç›‘æŽ§é¥°å“: AK-47 | çº¢çº¿\n\nðŸ“Š å®žæ—¶ä»·æ ¼æ•°æ®:\nðŸ’° é»˜è®¤å¹³å°: Â¥'${{ steps.real_prices.outputs.default_price }}'\nðŸš‚ Steamå¸‚åœº: Â¥'${{ steps.real_prices.outputs.steam_price }}'\nðŸŽ® BUFFé¥°å“: æŸ¥è¯¢ä¸­...\nðŸ›’ æ‚ æ‚ æœ‰å“: æŸ¥è¯¢ä¸­...\n\nðŸª æ•°æ®æ¥æº: CSQAQå®˜æ–¹API\nâœ… çŠ¶æ€: çœŸå®žæ•°æ®èŽ·å–æˆåŠŸ\nðŸ”„ ç›‘æŽ§é¢‘çŽ‡: æ¯30åˆ†é’Ÿè‡ªåŠ¨æ›´æ–°\n\nðŸ’¡ æç¤º: ä¸‹æ¬¡æ›´æ–°å°†åœ¨30åˆ†é’ŸåŽè‡ªåŠ¨æŽ¨é€æœ€æ–°ä»·æ ¼",
            "summary": "CS2é¥°å“ç›‘æŽ§ - çœŸå®žä»·æ ¼",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        echo "WXpusherå“åº”: $response"
        
        # æ£€æŸ¥å‘é€ç»“æžœ
        if [[ $response == *"code":1000* ]]; then
          echo "âœ… çœŸå®žä»·æ ¼ç›‘æŽ§é€šçŸ¥å‘é€æˆåŠŸ!"
        else
          echo "âŒ çœŸå®žä»·æ ¼ç›‘æŽ§é€šçŸ¥å‘é€å¤±è´¥"
          echo "å“åº”: $response"
        fi
        
    - name: æœ€ç»ˆæ‰§è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸ“Š CS2çœŸå®žä»·æ ¼ç›‘æŽ§æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **å½“å‰IP**: ${{ steps.ip.outputs.current_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§é¥°å“**: AK-47 | çº¢çº¿" >> $GITHUB_STEP_SUMMARY
        echo "- **é»˜è®¤ä»·æ ¼**: Â¥${{ steps.real_prices.outputs.default_price }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Steamä»·æ ¼**: Â¥${{ steps.real_prices.outputs.steam_price }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ•°æ®çŠ¶æ€**: ${{ steps.real_prices.outputs.has_real_data }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é€šçŸ¥è¯­è¨€**: ä¸­æ–‡" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§é¢‘çŽ‡**: æ¯30åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¸‹æ¬¡è¿è¡Œ**: $(date -d '+30 minutes' '+%H:%M')" >> $GITHUB_STEP_SUMMARY