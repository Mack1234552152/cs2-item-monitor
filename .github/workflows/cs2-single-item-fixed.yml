name: CS2 å•é¥°å“ç›‘æ§ - ä¸­æ–‡ç‰ˆ

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:
    inputs:
      item_name:
        description: 'é¥°å“åç§°'
        required: false
        default: 'M4A4 | æ´»è‰²ç”Ÿé¦™ (å´­æ–°å‡ºå‚)'
        type: string

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get current IP
      id: get-ip
      run: |
        current_ip=$(curl -s ifconfig.me)
        echo "å½“å‰IP: $current_ip"
        echo "IP=$current_ip" >> $GITHUB_OUTPUT
        
    - name: Set item info
      id: item-info
      run: |
        # ä½¿ç”¨è¾“å…¥å‚æ•°æˆ–é»˜è®¤å€¼
        item_name="${{ github.event.inputs.item_name || 'M4A4 | æ´»è‰²ç”Ÿé¦™ (å´­æ–°å‡ºå‚)' }}"
        
        echo "é¥°å“åç§°: $item_name"
        echo "NAME=$item_name" >> $GITHUB_OUTPUT
        
    - name: Bind IP to CSQAQ
      run: |
        echo "æ­£åœ¨ç»‘å®šIP: ${{ steps.get-ip.outputs.IP }}"
        
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/sys/bind_local_ip" \
          -H "Content-Type: application/json" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0")
        
        echo "IPç»‘å®šå“åº”: $response"
        
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… IPç»‘å®šæˆåŠŸ!"
          bound_ip=$(echo "$response" | grep -o 'å½“å‰ç»‘å®šIPä¸ºï¼š[^"]*' | cut -d'ï¼š' -f2)
          echo "ç»‘å®šIP: $bound_ip"
        else
          echo "âŒ IPç»‘å®šå¤±è´¥"
          exit 1
        fi
        
    - name: Wait for IP binding
      run: |
        echo "ç­‰å¾…20ç§’è®©IPç»‘å®šç”Ÿæ•ˆ..."
        sleep 20
        
    - name: Get CS2 Data and Send Notification
      run: |
        echo "æ­£åœ¨è·å–CS2æ•°æ®..."
        
        # è·å–å½“å‰æŒ‡æ•°æ•°æ®
        index_response=$(curl -s -X GET "https://api.csqaq.com/api/v1/current_data")
        
        if echo "$index_response" | grep -q '"code":200'; then
          echo "âœ… æŒ‡æ•°æ•°æ®è·å–æˆåŠŸ!"
          
          # è§£ææŒ‡æ•°æ•°æ®
          market_index=$(echo "$index_response" | grep -o '"market_index":[^,]*' | head -1 | cut -d':' -f2 | tr -d '" ')
          chg_rate=$(echo "$index_response" | grep -o '"chg_rate":[^,]*' | head -1 | cut -d':' -f2)
          online_players=$(echo "$index_response" | grep -o '"current_number":[^,}]*' | cut -d':' -f2)
          
          echo "é¥°å“æŒ‡æ•°: $market_index"
          echo "æ¶¨è·Œå¹…: $chg_rate%"
          echo "åœ¨çº¿äººæ•°: $online_players"
          
          # æ„å»ºä¸­æ–‡é€šçŸ¥å†…å®¹
          notification_content="CS2é¥°å“ä»·æ ¼ç›‘æ§

ğŸ¯ ç›‘æ§é¥°å“: ${{ steps.item-info.outputs.NAME }}

ğŸ“Š å½“å‰é¥°å“æŒ‡æ•°: $market_index
ğŸ“ˆ 24å°æ—¶æ¶¨è·Œ: $chg_rate%
ğŸ‘¥ åœ¨çº¿äººæ•°: $online_playersäºº

ğŸ• æ›´æ–°æ—¶é—´: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
ğŸŒ æœåŠ¡å™¨IP: ${{ steps.get-ip.outputs.IP }}

ğŸ“¢ ä»·æ ¼æ¥æº: CSQAQæ•°æ®å¹³å°
ğŸª æ•°æ®å¹³å°: BUFFæ‚ æ‚ æœ‰å“

ğŸ’¡ ç³»ç»ŸçŠ¶æ€: æ­£å¸¸è¿è¡Œä¸­

æ­¤ä»·æ ¼ä¸ºå‚è€ƒä»·æ ¼ï¼Œå®é™…äº¤æ˜“è¯·ä»¥å„å¹³å°ä¸ºå‡†"
          
          # å‘é€ä¸­æ–‡é€šçŸ¥
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$notification_content\",
              \"summary\": \"CS2é¥°å“ä»·æ ¼ç›‘æ§\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          
          echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ!"
        else
          echo "âŒ æŒ‡æ•°æ•°æ®è·å–å¤±è´¥"
          
          # å‘é€é”™è¯¯é€šçŸ¥
          error_content="CS2ç›‘æ§é”™è¯¯

âŒ é”™è¯¯ç±»å‹: æŒ‡æ•°æ•°æ®è·å–å¤±è´¥
ğŸ¯ ç›‘æ§é¥°å“: ${{ steps.item-info.outputs.NAME }}
ğŸ• é”™è¯¯æ—¶é—´: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
ğŸŒ æœåŠ¡å™¨IP: ${{ steps.get-ip.outputs.IP }}

ğŸ“¢ ä»·æ ¼æ¥æº: CSQAQæ•°æ®å¹³å°

ğŸ’¥ è¯·æ£€æŸ¥API Tokenæˆ–ç½‘ç»œè¿æ¥"
          
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$error_content\",
              \"summary\": \"CS2ç›‘æ§é”™è¯¯\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          exit 1
        fi
        
    - name: Status Report
      if: always()
      run: |
        echo "ğŸ“Š ä»»åŠ¡æ‰§è¡ŒæŠ¥å‘Š:"
        echo "â° æ‰§è¡Œæ—¶é—´: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')"
        echo "ğŸ“ æœåŠ¡å™¨IP: ${{ steps.get-ip.outputs.IP }}"
        echo "ğŸ¯ ç›‘æ§é¥°å“: ${{ steps.item-info.outputs.NAME }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ä»»åŠ¡çŠ¶æ€: æˆåŠŸå®Œæˆ"
        else
          echo "âŒ ä»»åŠ¡çŠ¶æ€: æ‰§è¡Œå¤±è´¥"
        fi