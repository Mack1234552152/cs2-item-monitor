name: CS2 Final Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 9 * * *'   # æ¯å¤©ä¸Šåˆ9ç‚¹é¢å¤–è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get current IP
      id: get-ip
      run: |
        current_ip=$(curl -s ifconfig.me)
        echo "Current IP: $current_ip"
        echo "IP=$current_ip" >> $GITHUB_OUTPUT
        
    - name: Bind IP to CSQAQ
      run: |
        echo "Binding IP: ${{ steps.get-ip.outputs.IP }}"
        
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/sys/bind_local_ip" \
          -H "Content-Type: application/json" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0")
        
        echo "IP binding response: $response"
        
        if echo "$response" | grep -q '"code":200'; then
          echo "âœ… IP binding successful!"
          bound_ip=$(echo "$response" | grep -o 'å½“å‰ç»‘å®šIPä¸ºï¼š[^"]*' | cut -d'ï¼š' -f2)
          echo "Bound IP: $bound_ip"
        else
          echo "âŒ IP binding failed"
          exit 1
        fi
        
    - name: Wait for IP binding to take effect
      run: |
        echo "Waiting for IP binding to take effect (30 seconds)..."
        for i in {30..1}; do
          echo "Waiting... $i seconds"
          sleep 1
        done
        echo "âœ… Waiting complete, fetching data"
        
    - name: Fetch CS2 Data
      run: |
        echo "Fetching CSQAQ data..."
        
        # è·å–CSQAQæ•°æ®
        api_response=$(curl -s -X GET "https://api.csqaq.com/api/v1/current_data")
        
        if echo "$api_response" | grep -q '"code":200'; then
          echo "âœ… Data fetch successful!"
          
          # è§£ææ•°æ®
          market_index=$(echo "$api_response" | grep -o '"market_index":[^,]*' | head -1 | cut -d':' -f2 | tr -d '" ')
          chg_rate=$(echo "$api_response" | grep -o '"chg_rate":[^,]*' | head -1 | cut -d':' -f2)
          online_players=$(echo "$api_response" | grep -o '"current_number":[^,}]*' | cut -d':' -f2)
          
          echo "Market Index: $market_index"
          echo "Change Rate: $chg_rate%"
          echo "Online Players: $online_players"
          
          # æ„å»ºé€šçŸ¥å†…å®¹
          notification_content="CS2é¥°å“ä»·æ ¼ç›‘æ§æ›´æ–°

å½“å‰é¥°å“æŒ‡æ•°: $market_index
æ¶¨è·Œå¹…: $chg_rate%
åœ¨çº¿äººæ•°: $online_playersäºº
æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
ç›‘æ§çŠ¶æ€: æ­£å¸¸è¿è¡Œ

IPåœ°å€: ${{ steps.get-ip.outputs.IP }}"
          
          # å‘é€æˆåŠŸé€šçŸ¥
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$notification_content\",
              \"summary\": \"CS2 Price Update\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          
          echo "ğŸ‰ Monitoring task completed, notification sent!"
        else
          echo "âŒ Data fetch failed"
          
          # å‘é€é”™è¯¯é€šçŸ¥
          error_content="CS2 Monitor Failed

Status: Data fetch failed
IP: ${{ steps.get-ip.outputs.IP }}
Time: $(date '+%Y-%m-%d %H:%M:%S')
Error: API data retrieval failed

Please check the workflow logs"
          
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d "{
              \"appToken\": \"AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz\",
              \"content\": \"$error_content\",
              \"summary\": \"CS2 Monitor Error\",
              \"contentType\": 1,
              \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
            }"
          exit 1
        fi
        
    - name: System Info
      if: always()
      run: |
        echo "ğŸ“Š Task execution information:"
        echo "â° Start time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ–¥ï¸ Runner: ${{ runner.os }}"
        echo "ğŸ“ IP: ${{ steps.get-ip.outputs.IP }}"
        echo "ğŸ“ Working directory: $(pwd)"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Task status: Successfully completed"
        else
          echo "âŒ Task status: Execution failed"
        fi