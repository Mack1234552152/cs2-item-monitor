name: Test CSQAQ IP Binding Issue

on:
  workflow_dispatch:

jobs:
  test-ip-binding:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Current IP and API Status
      run: |
        echo "=== ğŸ” CSQAQ API IPç™½åå•éªŒè¯ ==="
        echo "å½“å‰GitHub Actions IPåœ°å€:"
        
        # è·å–å½“å‰å…¬ç½‘IP
        CURRENT_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip)
        echo "IPåœ°å€: $CURRENT_IP"
        
        echo ""
        echo "ğŸ“‹ CSQAQ APIè¦æ±‚ï¼š"
        echo "1. å¿…é¡»å…ˆç»‘å®šIPåˆ°ç™½åå•"
        echo "2. éœ€è¦æœ‰æ•ˆçš„ApiToken"
        echo "3. å½“å‰IP: $CURRENT_IP"
        echo ""
        
    - name: Test API Without IP Binding (Expected to Fail)
      run: |
        echo "=== âŒ æµ‹è¯•APIè°ƒç”¨ï¼ˆé¢„æœŸå¤±è´¥ï¼‰ ==="
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{"limit": 1, "page": 1}')
        
        echo "APIå“åº”: $response"
        
        if [[ $response == *"è¯·æ±‚çš„åœ°å€éæ³•"* ]]; then
          echo "âŒ ç¡®è®¤ï¼šéœ€è¦IPç™½åå•ç»‘å®š"
        else
          echo "âœ… APIè°ƒç”¨æˆåŠŸ"
        fi
        
    - name: Send Problem Report via WXpusher
      run: |
        echo "=== ğŸ“± å‘é€é—®é¢˜æŠ¥å‘Š ==="
        
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "ğŸš¨ CSQAQ APIé—®é¢˜å·²ç¡®è®¤\\n\\nâš ï¸ å‘ç°æ ¹æœ¬é—®é¢˜ï¼š\\nâ€¢ GitHub Actions IPä¸åœ¨CSQAQç™½åå•\\nâ€¢ éœ€è¦å…ˆç»‘å®šIPåœ°å€\\nâ€¢ ApiTokenå¯èƒ½éœ€è¦é‡æ–°è·å–\\n\\nğŸ“‹ è§£å†³æ–¹æ¡ˆï¼š\\n1. è”ç³»CSQAQç®¡ç†å‘˜ç»‘å®šIP\\n2. æˆ–ä½¿ç”¨å…¶ä»–æ•°æ®æºï¼ˆå¦‚Steam APIã€Buff APIï¼‰\\n3. è€ƒè™‘ä½¿ç”¨VPSå›ºå®šIP\\n\\nğŸ’¡ å»ºè®®ï¼š\\næš‚æ—¶æ— æ³•é€šè¿‡CSQAQ APIè·å–æ•°æ®ï¼Œéœ€è¦æ›´æ¢æ•°æ®æº",
            "summary": "CSQAQ APIéœ€è¦IPç™½åå•ç»‘å®š",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        echo "WXpusherå‘é€çŠ¶æ€: $response"