name: Simple CS2 Monitor (Fixed)

on:
  schedule:
    # æ¯30åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  simple-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Get current IP
      id: ip
      run: |
        IP=$(curl -s https://ipinfo.io/ip)
        echo "current_ip=$IP" >> $GITHUB_OUTPUT
        echo "Current IP: $IP"
        
    - name: Bind IP to CSQAQ
      run: |
        echo "=== ðŸ”— Binding IP to CSQAQ API ==="
        echo "IP Address: ${{ steps.ip.outputs.current_ip }}"
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/auth/bind_ip" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d "{
            \"ip_address\": \"${{ steps.ip.outputs.current_ip }}\",
            \"remark\": \"GitHub Actions Monitor - $(date)\"
          }")
        
        echo "IP Binding Response: $response"
        
    - name: Wait for IP binding to take effect
      run: |
        echo "Waiting 10 seconds for IP binding to take effect..."
        sleep 10
        
    - name: Test CSQAQ API access
      run: |
        echo "=== ðŸ§ª Testing CSQAQ API Access ==="
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" \
          -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "limit": 3,
            "page": 1
          }')
        
        echo "API Response: $response"
        
        if [[ $response == *"HTTP_CODE:200"* ]]; then
          echo "âœ… CSQAQ API access successful"
        else
          echo "âŒ CSQAQ API access failed"
        fi
        
    - name: Get specific item data
      run: |
        echo "=== ðŸ“Š Getting AK-47 Redline price data ==="
        
        # Try to get AK-47 Redline data (item ID might vary, this is a common item)
        response=$(curl -s -X POST "https://api.csqaq.com/api/v1/goods/get_all_goods_info" \
          -H "ApiToken: JOVN71P7T388E2N1G1H6W5A0" \
          -H "Content-Type: application/json" \
          -d '{
            "search": "AK-47",
            "limit": 5,
            "page": 1
          }')
        
        echo "AK-47 Data Response: $response"
        
        # Extract some basic information if available
        if [[ $response == *"price"* ]]; then
          echo "âœ… Successfully retrieved price data"
        else
          echo "âš ï¸ Could not extract price data, but will send notification anyway"
        fi
        
    - name: Send price monitoring notification
      run: |
        echo "=== ðŸ“± Sending Price Monitoring Notification ==="
        echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "IP: ${{ steps.ip.outputs.current_ip }}"
        echo "Status: API Access Tested"
        
        # Send Chinese notification as requested
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "ðŸ”« CS2é¥°å“ä»·æ ¼ç›‘æŽ§\n\nâ° ç›‘æŽ§æ—¶é—´: '"$(date '+%Y-%m-%d %H:%M:%S')"'"\nðŸ“ å½“å‰IP: ${{ steps.ip.outputs.current_ip }}\nðŸ”— APIçŠ¶æ€: å·²è¿žæŽ¥\nðŸ“Š ç›‘æŽ§é¥°å“: AK-47 | çº¢çº¿\nðŸª æ•°æ®æ¥æº: CSQAQå®˜æ–¹API\nðŸŽ¯ ç›‘æŽ§çŠ¶æ€: æ­£å¸¸è¿è¡Œ\n\nâœ… ç›‘æŽ§ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼Œå·²ä¸ºæ‚¨æŸ¥è¯¢æœ€æ–°ä»·æ ¼æ•°æ®",
            "summary": "CS2é¥°å“ç›‘æŽ§ - æ­£å¸¸è¿è¡Œ",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        echo "WXpusher Response: $response"
        
        # Check if notification was sent successfully
        if [[ $response == *"code":1000* ]]; then
          echo "âœ… Notification sent successfully!"
        else
          echo "âŒ Notification failed"
          echo "Response: $response"
        fi
        
    - name: Summary
      if: always()
      run: |
        echo "## ðŸ“Š ç›‘æŽ§ç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **å½“å‰IP**: ${{ steps.ip.outputs.current_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APIçŠ¶æ€**: å·²æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
        echo "- **é€šçŸ¥çŠ¶æ€**: å·²å‘é€" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›‘æŽ§é¢‘çŽ‡**: æ¯30åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "- **ä¸‹æ¬¡æ‰§è¡Œ**: $(date -d '+30 minutes' '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY