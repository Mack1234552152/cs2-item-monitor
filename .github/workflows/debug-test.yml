name: Debug Test

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Basic Environment Test
      run: |
        echo "=== åŸºæœ¬çŽ¯å¢ƒæµ‹è¯• ==="
        echo "Node.jsç‰ˆæœ¬:"
        node --version
        echo "npmç‰ˆæœ¬:"
        npm --version
        echo "å½“å‰ç›®å½•:"
        pwd
        echo "ç›®å½•å†…å®¹:"
        ls -la
        
    - name: Install Dependencies Test  
      run: |
        echo "=== ä¾èµ–å®‰è£…æµ‹è¯• ==="
        npm install axios
        echo "axioså®‰è£…çŠ¶æ€: $?"
        
    - name: Create Simple Config
      run: |
        echo "=== åˆ›å»ºç®€å•é…ç½® ==="
        mkdir -p config
        echo '{"test": "value"}' > config/test.json
        echo "é…ç½®æ–‡ä»¶å†…å®¹:"
        cat config/test.json
        
    - name: Test WXpusher Direct
      run: |
        echo "=== ç›´æŽ¥æµ‹è¯•WXpusher ==="
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj",
            "content": "ðŸ”§ Debugæµ‹è¯• - ç›´æŽ¥curlè°ƒç”¨\n\nâ° æ—¶é—´: '"$(date)"'\nâœ… æµ‹è¯•çŠ¶æ€: è¿è¡Œä¸­",
            "summary": "Debugæµ‹è¯•é€šçŸ¥",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        
        echo "APIå“åº”: $response"
        
        if echo "$response" | grep -q '"code":1000'; then
          echo "âœ… WXpusherç›´æŽ¥è°ƒç”¨æˆåŠŸ"
          echo "## ðŸŽ‰ Debugæµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **WXpusheræµ‹è¯•**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **å“åº”**: $response" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ WXpusherç›´æŽ¥è°ƒç”¨å¤±è´¥"
          echo "## âŒ Debugæµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **WXpusheræµ‹è¯•**: âŒ å¤±è´¥" >> $GITHUB_STEP_SUMMARY  
          echo "- **å“åº”**: $response" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” é”™è¯¯åˆ†æž" >> $GITHUB_STEP_SUMMARY
          echo "- **AppToken**: AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj" >> $GITHUB_STEP_SUMMARY
          echo "- **UID**: UID_Nkv98Q7XEQcDsvSInIlR10nm33xI" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯èƒ½åŽŸå› **: AppTokenæ— æ•ˆã€UIDé”™è¯¯æˆ–APIé™åˆ¶" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Test Basic Node.js Script
      run: |
        echo "=== æµ‹è¯•åŸºç¡€Node.jsè„šæœ¬ ==="
        
        cat > test-script.js << 'EOF'
        console.log('å¼€å§‹Node.jsæµ‹è¯•...');
        
        try {
          const https = require('https');
          const http = require('http');
          
          console.log('âœ… Node.jsæ¨¡å—åŠ è½½æ­£å¸¸');
          
          // æµ‹è¯•HTTPSè¯·æ±‚
          const testData = JSON.stringify({
            appToken: 'AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj',
            content: 'ðŸ”§ Node.jsæµ‹è¯•\nâ° æ—¶é—´: ' + new Date().toLocaleString(),
            summary: 'Node.js HTTPSæµ‹è¯•',
            contentType: 1,
            uids: ['UID_Nkv98Q7XEQcDsvSInIlR10nm33xI']
          });
          
          const options = {
            hostname: 'wxpusher.zjiecode.com',
            port: 443,
            path: '/api/send/message',
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Content-Length': Buffer.byteLength(testData)
            }
          };
          
          const req = https.request(options, (res) => {
            console.log('çŠ¶æ€ç :', res.statusCode);
            console.log('å“åº”å¤´:', res.headers);
            
            let data = '';
            res.on('data', (chunk) => {
              data += chunk;
            });
            
            res.on('end', () => {
              console.log('å“åº”ä½“:', data);
              try {
                const result = JSON.parse(data);
                if (result.code === 1000) {
                  console.log('âœ… Node.js HTTPSè¯·æ±‚æˆåŠŸ!');
                  process.exit(0);
                } else {
                  console.log('âŒ APIè¿”å›žé”™è¯¯:', result);
                  process.exit(1);
                }
              } catch (e) {
                console.log('âŒ JSONè§£æžå¤±è´¥:', e.message);
                process.exit(2);
              }
            });
          });
          
          req.on('error', (e) => {
            console.error('âŒ è¯·æ±‚å¤±è´¥:', e.message);
            process.exit(3);
          });
          
          req.write(testData);
          req.end();
          
        } catch (error) {
          console.error('âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥:', error.message);
          process.exit(4);
        }
        EOF
        
        echo "è¿è¡ŒNode.jsæµ‹è¯•è„šæœ¬..."
        node test-script.js
        script_result=$?
        
        echo "è„šæœ¬é€€å‡ºç : $script_result"
        
        case $script_result in
          0) 
            echo "âœ… Node.jsæµ‹è¯•æˆåŠŸ"
            echo "- **Node.jsæµ‹è¯•**: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            ;;
          1) 
            echo "âŒ APIè¿”å›žé”™è¯¯"
            echo "- **Node.jsæµ‹è¯•**: âŒ APIé”™è¯¯" >> $GITHUB_STEP_SUMMARY
            ;;
          2) 
            echo "âŒ JSONè§£æžå¤±è´¥"
            echo "- **Node.jsæµ‹è¯•**: âŒ JSONé”™è¯¯" >> $GITHUB_STEP_SUMMARY
            ;;
          3) 
            echo "âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥"
            echo "- **Node.jsæµ‹è¯•**: âŒ ç½‘ç»œé”™è¯¯" >> $GITHUB_STEP_SUMMARY
            ;;
          4) 
            echo "âŒ è„šæœ¬æ‰§è¡Œå¼‚å¸¸"
            echo "- **Node.jsæµ‹è¯•**: âŒ è„šæœ¬é”™è¯¯" >> $GITHUB_STEP_SUMMARY
            ;;
          *) 
            echo "â“ æœªçŸ¥é”™è¯¯"
            echo "- **Node.jsæµ‹è¯•**: â“ æœªçŸ¥é”™è¯¯" >> $GITHUB_STEP_SUMMARY
            ;;
        esac