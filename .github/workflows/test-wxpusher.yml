name: WXpusher Notification Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - simple
          - price_alert
          - app_info

jobs:
  test-wxpusher:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create test config
      run: |
        cat > config/config.json << EOF
        {
          "api": {
            "csqaq": {
              "baseUrl": "https://api.csqaq.com/api/v1",
              "token": "JOVN71P7T388E2N1G1H6W5A0",
              "whitelist_ip": "111.19.113.82"
            }
          },
          "notification": {
            "wxpusher": {
              "appToken": "${{ secrets.WXPUSHER_APP_TOKEN }}",
              "baseUrl": "https://wxpusher.zjiecode.com"
            }
          }
        }
        EOF
        
    - name: Check WXpusher configuration
      run: |
        echo "## ðŸ”§ WXpusheré…ç½®æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        if [ -z "${{ secrets.WXPUSHER_APP_TOKEN }}" ]; then
          echo "âŒ WXPUSHER_APP_TOKEN æœªé…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "è¯·åœ¨GitHub Secretsä¸­æ·»åŠ WXPUSHER_APP_TOKEN" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… WXPUSHER_APP_TOKEN å·²é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "Tokené•¿åº¦: $(echo -n "${{ secrets.WXPUSHER_APP_TOKEN }}" | wc -c)" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Create required directories
      run: |
        mkdir -p data logs config
        
    - name: Run WXpusher test
      id: wxpusher-test
      continue-on-error: true
      run: |
        echo "ðŸ§ª å¼€å§‹WXpusheré›†æˆæµ‹è¯•..."
        echo "æµ‹è¯•ç±»åž‹: ${{ github.event.inputs.test_type || 'all' }}"
        echo "æµ‹è¯•æ—¶é—´: $(date)"
        echo "================================================"
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡ä¾›æµ‹è¯•è„šæœ¬ä½¿ç”¨
        export TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
        
        # è¿è¡Œæµ‹è¯•è„šæœ¬
        timeout 120s node scripts/test-wxpusher.js
        
    - name: Show test results
      if: always()
      run: |
        echo "## ðŸ“Š WXpusheræµ‹è¯•ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **æµ‹è¯•ç±»åž‹**: ${{ github.event.inputs.test_type || 'all' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ steps.wxpusher-test.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é…ç½®çŠ¶æ€**: ${{ secrets.WXPUSHER_APP_TOKEN != '' && 'âœ… å·²é…ç½®' || 'âŒ æœªé…ç½®' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” æ•…éšœæŽ’é™¤è¯´æ˜Ž:" >> $GITHUB_STEP_SUMMARY
        echo "1. ç¡®è®¤WXPUSHER_APP_TOKENåœ¨GitHub Secretsä¸­æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
        echo "2. æ£€æŸ¥å¾®ä¿¡æ˜¯å¦å…³æ³¨äº†WXpusherå…¬ä¼—å·" >> $GITHUB_STEP_SUMMARY
        echo "3. ç¡®è®¤WXpusheråº”ç”¨é…ç½®æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
        echo "4. æŸ¥çœ‹ä¸Šé¢çš„æ—¥å¿—è¾“å‡ºèŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wxpusher-test-logs-${{ github.run_number }}
        path: |
          logs/
        retention-days: 3
        if-no-files-found: ignore