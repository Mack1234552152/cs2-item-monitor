name: Manual Test Notification

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'simple'
        type: choice
        options:
        - simple
        - chinese
        - english

jobs:
  send-test:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: Get current IP
      id: ip
      run: |
        IP=$(curl -s https://ipinfo.io/ip)
        echo "current_ip=$IP" >> $GITHUB_OUTPUT
        
    - name: Send test notification
      run: |
        echo "=== 🧪 Sending Test Notification ==="
        echo "Test Type: ${{ github.event.inputs.test_type || 'simple' }}"
        echo "Time: $(date)"
        echo "IP: ${{ steps.ip.outputs.current_ip }}"
        
        if [[ "${{ github.event.inputs.test_type }}" == "chinese" ]]; then
          # Chinese notification
          response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
              "content": "🔧 手动测试通知\n\n⏰ 测试时间: '"$(date '+%Y-%m-%d %H:%M:%S')"'"\n📍 当前IP: ${{ steps.ip.outputs.current_ip }}\n🎯 测试类型: 中文通知\n✅ 这是一个手动测试通知，用于验证系统状态",
              "summary": "手动测试 - 中文通知",
              "contentType": 1,
              "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
            }')
        elif [[ "${{ github.event.inputs.test_type }}" == "english" ]]; then
          # English notification
          response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
              "content": "🔧 Manual Test Notification\n\n⏰ Test Time: '"$(date '+%Y-%m-%d %H:%M:%S')"'"\n📍 Current IP: ${{ steps.ip.outputs.current_ip }}\n🎯 Test Type: English Notification\n✅ This is a manual test notification to verify system status",
              "summary": "Manual Test - English",
              "contentType": 1,
              "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
            }')
        else
          # Simple default notification
          response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
              "content": "测试通知\n\n时间: '"$(date '+%Y-%m-%d %H:%M:%S')"'"\nIP: ${{ steps.ip.outputs.current_ip }}\n状态: 正常",
              "summary": "测试通知",
              "contentType": 1,
              "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
            }')
        fi
        
        echo "WXpusher Response: $response"
        
        # Check result
        if [[ $response == *"code":1000* ]]; then
          echo "✅ Test notification sent successfully!"
          echo "Result: SUCCESS"
        else
          echo "❌ Test notification failed"
          echo "Response: $response"
          echo "Result: FAILED"
        fi