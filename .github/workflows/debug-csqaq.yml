name: Debug CSQAQ API Issues

on:
  workflow_dispatch:

jobs:
  debug-csqaq:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug CSQAQ API Issues
      run: |
        echo "=== 🔍 CSQAQ API Debug Report ==="
        echo "时间: $(date)"
        echo "当前配置存在问题！"
        echo ""
        echo "❌ 发现的问题："
        echo "1. API端点返回401错误：'请求的地址非法，请更换请求链接'"
        echo "2. 可能的原因："
        echo "   - API端点URL已更改"
        echo "   - API认证方式不正确"
        echo "   - Token已失效"
        echo "   - API服务已停止"
        echo ""
        echo "🔧 当前配置："
        echo "- Base URL: https://api.csqaq.com/api/v1"
        echo "- Token: JOVN71P7T388E2N1G1H6W5A0"
        echo "- 白名单IP: 111.19.113.82"
        echo ""
        echo "🌐 测试结果："
        
        # Test multiple possible endpoints
        endpoints=(
          "https://api.csqaq.com/api/v1/items"
          "https://api.csqaq.com/api/v1/price"
          "https://api.csqaq.com/api/v1/"
          "https://csqaq.com/api/v1/items"
          "https://csqaq.com/api/v1/price"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing: $endpoint"
          response=$(curl -s -w "HTTP:%{http_code}" "$endpoint" --connect-timeout 5)
          if [[ $response == *"HTTP:"* ]]; then
            http_code=$(echo "$response" | grep -o "HTTP:[0-9]*" | cut -d: -f2)
            response_body=$(echo "$response" | sed 's/HTTP:[0-9]*$//')
            echo "  Status: $http_code"
            echo "  Response: $response_body"
          else
            echo "  Failed: No response"
          fi
          echo ""
        done
        
    - name: Test Different Auth Methods
      run: |
        echo "=== 🔐 Testing Authentication Methods ==="
        
        token="JOVN71P7T388E2N1G1H6W5A0"
        endpoint="https://api.csqaq.com/api/v1/items"
        
        auth_methods=(
          "Authorization: Bearer $token"
          "token: $token"
          "X-API-Token: $token"
          "api-token: $token"
        )
        
        for auth in "${auth_methods[@]}"; do
          echo "Testing with: $auth"
          header_name=$(echo "$auth" | cut -d: -f1)
          header_value=$(echo "$auth" | cut -d: -f2- | sed 's/^ *//')
          
          response=$(curl -s -w "HTTP:%{http_code}" \
            -H "$header_name: $header_value" \
            -H "Content-Type: application/json" \
            "$endpoint" --connect-timeout 5)
            
          if [[ $response == *"HTTP:"* ]]; then
            http_code=$(echo "$response" | grep -o "HTTP:[0-9]*" | cut -d: -f2)
            response_body=$(echo "$response" | sed 's/HTTP:[0-9]*$//')
            echo "  Status: $http_code"
            if [[ $response_body != *"请求的地址非法"* ]]; then
              echo "  Response: $response_body ✅"
            else
              echo "  Response: $response_body ❌"
            fi
          else
            echo "  Failed: No response"
          fi
          echo ""
        done
        
    - name: Send Problem Report via WXpusher
      run: |
        echo "=== 📱 发送问题报告 ==="
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "⚠️ CSQAQ API问题发现\\n\\n🚨 重要：CSQAQ API无法正常调用！\\n\\n📊 测试结果：\\n• API返回401错误\\n• 错误信息："请求的地址非法，请更换请求链接"\\n\\n🔧 需要处理：\\n1. 确认CSQAQ API是否仍在服务\\n2. 获取正确的API端点URL\\n3. 确认认证方式\\n4. 更新Token和配置\\n\\n💡 当前价格监控可能无法正常工作！\\n📍 请检查CSQAQ官方文档获取最新API信息。",
            "summary": "🚨 CSQAQ API问题 - 需要立即处理",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        echo "WXpusher response: $response"