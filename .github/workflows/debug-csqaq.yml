name: Debug CSQAQ API Issues

on:
  workflow_dispatch:

jobs:
  debug-csqaq:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug CSQAQ API Issues
      run: |
        echo "=== ğŸ” CSQAQ API Debug Report ==="
        echo "æ—¶é—´: $(date)"
        echo "å½“å‰é…ç½®å­˜åœ¨é—®é¢˜ï¼"
        echo ""
        echo "âŒ å‘ç°çš„é—®é¢˜ï¼š"
        echo "1. APIç«¯ç‚¹è¿”å›401é”™è¯¯ï¼š'è¯·æ±‚çš„åœ°å€éæ³•ï¼Œè¯·æ›´æ¢è¯·æ±‚é“¾æ¥'"
        echo "2. å¯èƒ½çš„åŸå› ï¼š"
        echo "   - APIç«¯ç‚¹URLå·²æ›´æ”¹"
        echo "   - APIè®¤è¯æ–¹å¼ä¸æ­£ç¡®"
        echo "   - Tokenå·²å¤±æ•ˆ"
        echo "   - APIæœåŠ¡å·²åœæ­¢"
        echo ""
        echo "ğŸ”§ å½“å‰é…ç½®ï¼š"
        echo "- Base URL: https://api.csqaq.com/api/v1"
        echo "- Token: JOVN71P7T388E2N1G1H6W5A0"
        echo "- ç™½åå•IP: 111.19.113.82"
        echo ""
        echo "ğŸŒ æµ‹è¯•ç»“æœï¼š"
        
        # Test multiple possible endpoints
        endpoints=(
          "https://api.csqaq.com/api/v1/items"
          "https://api.csqaq.com/api/v1/price"
          "https://api.csqaq.com/api/v1/"
          "https://csqaq.com/api/v1/items"
          "https://csqaq.com/api/v1/price"
        )
        
        for endpoint in "${endpoints[@]}"; do
          echo "Testing: $endpoint"
          response=$(curl -s -w "HTTP:%{http_code}" "$endpoint" --connect-timeout 5)
          if [[ $response == *"HTTP:"* ]]; then
            http_code=$(echo "$response" | grep -o "HTTP:[0-9]*" | cut -d: -f2)
            response_body=$(echo "$response" | sed 's/HTTP:[0-9]*$//')
            echo "  Status: $http_code"
            echo "  Response: $response_body"
          else
            echo "  Failed: No response"
          fi
          echo ""
        done
        
    - name: Test Different Auth Methods
      run: |
        echo "=== ğŸ” Testing Authentication Methods ==="
        
        token="JOVN71P7T388E2N1G1H6W5A0"
        endpoint="https://api.csqaq.com/api/v1/items"
        
        auth_methods=(
          "Authorization: Bearer $token"
          "token: $token"
          "X-API-Token: $token"
          "api-token: $token"
        )
        
        for auth in "${auth_methods[@]}"; do
          echo "Testing with: $auth"
          header_name=$(echo "$auth" | cut -d: -f1)
          header_value=$(echo "$auth" | cut -d: -f2- | sed 's/^ *//')
          
          response=$(curl -s -w "HTTP:%{http_code}" \
            -H "$header_name: $header_value" \
            -H "Content-Type: application/json" \
            "$endpoint" --connect-timeout 5)
            
          if [[ $response == *"HTTP:"* ]]; then
            http_code=$(echo "$response" | grep -o "HTTP:[0-9]*" | cut -d: -f2)
            response_body=$(echo "$response" | sed 's/HTTP:[0-9]*$//')
            echo "  Status: $http_code"
            if [[ $response_body != *"è¯·æ±‚çš„åœ°å€éæ³•"* ]]; then
              echo "  Response: $response_body âœ…"
            else
              echo "  Response: $response_body âŒ"
            fi
          else
            echo "  Failed: No response"
          fi
          echo ""
        done
        
    - name: Send Problem Report via WXpusher
      run: |
        echo "=== ğŸ“± å‘é€é—®é¢˜æŠ¥å‘Š ==="
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{
            "appToken": "AT_oVgZnjiSqzzv1ycEbihcgjtoM4BggMjz",
            "content": "âš ï¸ CSQAQ APIé—®é¢˜å‘ç°\\n\\nğŸš¨ é‡è¦ï¼šCSQAQ APIæ— æ³•æ­£å¸¸è°ƒç”¨ï¼\\n\\nğŸ“Š æµ‹è¯•ç»“æœï¼š\\nâ€¢ APIè¿”å›401é”™è¯¯\\nâ€¢ é”™è¯¯ä¿¡æ¯ï¼š"è¯·æ±‚çš„åœ°å€éæ³•ï¼Œè¯·æ›´æ¢è¯·æ±‚é“¾æ¥"\\n\\nğŸ”§ éœ€è¦å¤„ç†ï¼š\\n1. ç¡®è®¤CSQAQ APIæ˜¯å¦ä»åœ¨æœåŠ¡\\n2. è·å–æ­£ç¡®çš„APIç«¯ç‚¹URL\\n3. ç¡®è®¤è®¤è¯æ–¹å¼\\n4. æ›´æ–°Tokenå’Œé…ç½®\\n\\nğŸ’¡ å½“å‰ä»·æ ¼ç›‘æ§å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼\\nğŸ“ è¯·æ£€æŸ¥CSQAQå®˜æ–¹æ–‡æ¡£è·å–æœ€æ–°APIä¿¡æ¯ã€‚",
            "summary": "ğŸš¨ CSQAQ APIé—®é¢˜ - éœ€è¦ç«‹å³å¤„ç†",
            "contentType": 1,
            "uids": ["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]
          }')
        echo "WXpusher response: $response"