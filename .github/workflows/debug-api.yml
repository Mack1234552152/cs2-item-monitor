name: Debug WXpusher API

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug WXpusher API - Step 1
      run: |
        echo "=== Step 1: Testing basic connectivity ==="
        echo "Current time: $(date)"
        echo "Testing WXpusher API..."
        
    - name: Debug WXpusher API - Step 2
      run: |
        echo "=== Step 2: Testing API call ==="
        echo "AppToken: AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj"
        echo "UID: UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"
        
        response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d "{
            \"appToken\": \"AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj\",
            \"content\": \"🔧 API测试 - Step 2\\n\\n⏰ 时间: $(date)\\n✅ 测试状态: API调用中\\n🔍 调试步骤: 第2步\",
            \"summary\": \"API调试测试\",
            \"contentType\": 1,
            \"uids\": [\"UID_Nkv98Q7XEQcDsvSInIlR10nm33xI\"]
          }")
        
        echo "Response: $response"
        echo "Response length: $(echo $response | wc -c)"
        
        # Check if response is empty
        if [ -z "$response" ]; then
          echo "❌ ERROR: Empty response from API"
        else
          echo "✅ Response received"
          echo "$response" | python3 -m json.tool 2>/dev/null || echo "Response is not valid JSON"
        fi
        
    - name: Debug WXpusher API - Step 3
      run: |
        echo "=== Step 3: Testing with minimal payload ==="
        
        response=$(curl -v -X POST "https://wxpusher.zjiecode.com/api/send/message" \
          -H "Content-Type: application/json" \
          -d '{"appToken":"AT_MGRDCtFJyM0GSpNDL5Kx3veU7WVpc3nj","content":"Test message","summary":"Test","contentType":1,"uids":["UID_Nkv98Q7XEQcDsvSInIlR10nm33xI"]}' 2>&1)
        
        echo "Verbose response:"
        echo "$response"
        
    - name: Final Check
      run: |
        echo "=== Debug completed ==="
        echo "If you see this message, the workflow ran successfully"
        echo "Check your WXpusher for notifications"