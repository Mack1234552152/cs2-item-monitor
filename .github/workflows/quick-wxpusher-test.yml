name: Quick WXpusher Test

on:
  workflow_dispatch:

jobs:
  test-wxpusher:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: Test WXpusher
      run: |
        echo "🧪 Testing WXpusher with AppToken: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0"
        
        # Test with simple curl command first
        response=$(curl -s -X GET "https://wxpusher.zjiecode.com/api/fun/app/AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0")
        echo "App Info Response: $response"
        
        # Test users
        users_response=$(curl -s -X GET "https://wxpusher.zjiecode.com/api/fun/wxuser?appToken=AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0&page=1&pageSize=10")
        echo "Users Response: $users_response"
        
        # Check if we have users
        if echo "$users_response" | grep -q '"code":1000'; then
          echo "✅ AppToken is valid"
          
          # Send test message
          message_response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0",
              "contentType": 1,
              "content": "🧪 WXpusher测试成功!\n\n时间: '$(date)'",
              "summary": "WXpusher测试消息"
            }')
          echo "Message Response: $message_response"
          
          if echo "$message_response" | grep -q '"code":1000'; then
            echo "🎉 Message sent successfully!"
            echo "您应该收到微信消息了！"
          else
            echo "❌ Message send failed"
            exit 1
          fi
        else
          echo "❌ Invalid AppToken or no users found"
          echo "请检查:"
          echo "1. AppToken是否正确: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0"
          echo "2. 是否有关注用户"
          exit 1
        fi