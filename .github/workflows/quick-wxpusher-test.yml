name: Quick WXpusher Test

on:
  workflow_dispatch:

jobs:
  test-wxpusher:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
    - name: Test WXpusher
      run: |
        echo "ğŸ§ª Testing WXpusher with AppToken: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0"
        
        # Test with simple curl command first
        response=$(curl -s -X GET "https://wxpusher.zjiecode.com/api/fun/app/AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0")
        echo "App Info Response: $response"
        
        # Test users
        users_response=$(curl -s -X GET "https://wxpusher.zjiecode.com/api/fun/wxuser?appToken=AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0&page=1&pageSize=10")
        echo "Users Response: $users_response"
        
        # Check if we have users
        if echo "$users_response" | grep -q '"code":1000'; then
          echo "âœ… AppToken is valid"
          
          # Send test message
          message_response=$(curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0",
              "contentType": 1,
              "content": "ğŸ§ª WXpusheræµ‹è¯•æˆåŠŸ!\n\næ—¶é—´: '$(date)'",
              "summary": "WXpusheræµ‹è¯•æ¶ˆæ¯"
            }')
          echo "Message Response: $message_response"
          
          if echo "$message_response" | grep -q '"code":1000'; then
            echo "ğŸ‰ Message sent successfully!"
            echo "æ‚¨åº”è¯¥æ”¶åˆ°å¾®ä¿¡æ¶ˆæ¯äº†ï¼"
          else
            echo "âŒ Message send failed"
            exit 1
          fi
        else
          echo "âŒ Invalid AppToken or no users found"
          echo "è¯·æ£€æŸ¥:"
          echo "1. AppTokenæ˜¯å¦æ­£ç¡®: AT_GHMCWdYblRKN9a0TMzzb4tVDQ0sajXD0"
          echo "2. æ˜¯å¦æœ‰å…³æ³¨ç”¨æˆ·"
          exit 1
        fi